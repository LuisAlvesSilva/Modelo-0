USE [DATACLASSIC]
GO

/****** Object:  View [dbo].[BM_ANALISEFINANC]    Script Date: 05/03/2024 08:40:55 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE VIEW [dbo].[BM_ANALISEFINANC]
AS

SELECT TB04010_CODIGO Titulo,
	   TB04010_CODEMP Codemp,
	   TB01007_NOME Empresa,
	   TB04010_DATA Data,
	   FORMAT(TB04010_DATA, 'yyyy-MM') MêsAjustado,
	   TB04010_CODCLI CodCli,
	   VW04004.TB01008_NOME Cliente,
	   TB00012_ESTADO Estado,
	   TB00012_Cidade Cidade,
	   TB01019_NOME Nível,
	   dbo.TB01107.TB01107_NOME GrupoEconomico,
	   VW04004.TB04003_NOME TipDoc,
	   CASE WHEN TIPDOC.TB04003_DUVIDOSO = 'S' THEN 'Sim' ELSE 'Não' END Duvidoso,
	   TB04004_NOME Centro,
	   TB04005_NOME Subcentro,
	   TB04010_DTVENCORIGINAL VencimentoOriginal,
	   TB04010_DTVENC + TIPDOC.TB04003_NUMERO_DIAS Vencimento,
	   YEAR(TB04010_DTVENC + TIPDOC.TB04003_NUMERO_DIAS) Ano,
	   TB04010_VLRBRUTO ValorBruto,
	   TB04010_VLRACRES ValorAcréscimo,
	   TB04010_VLRDESCONTO ValorDesconto,
	   TB04010_VLRTITULO ValorLiquido,
	   CASE WHEN TB04011_DTBAIXA IS NULL AND CAST(GETDATE() as date) > CAST(TB04010_DTVENC + TIPDOC.TB04003_NUMERO_DIAS + 2 as date) THEN TB04010_VLRTITULO ELSE 0 END ValorInadimplência,
	   TB04011_DTBAIXA DataBaixa,
	   TB04010_VLRPAGO ValorPago,
	   VW04004.TB01006_NOME Vendedor,
	   'Receber' Tipo,
	   'Competência' TipoRegime,
	   NULL Previsão,
	   TB04008_NOME Banco
  FROM VW04004
LEFT JOIN TB01008 AS CLI2 ON CLI2.TB01008_CODIGO = TB04010_CODCLI
LEFT JOIN TB01107 ON TB01107_CODIGO = CLI2.TB01008_GRUPO
LEFT JOIN TB01019 ON TB01019_CODIGO = CLI2.TB01008_NIVEL
LEFT JOIN TB00012 ON TB00012_CODIGO = VW04004.TB04010_CODCLI
				 AND TB00012_TABELA = 'TB01008'
				 AND TB00012_TIPO = '01'
LEFT JOIN TB04003 AS TIPDOC ON TIPDOC.TB04003_CODIGO = TB04010_TIPDOC
 WHERE TB04010_VLRTITULO > 0

UNION

SELECT TB04014_CODIGO Titulo,
	   TB04014_CODEMP Codemp,
	   TB01007_NOME Empresa,
	   TB04014_DATA Data,
	   FORMAT(TB04014_DATA, 'yyyy-MM') MêsAjustado,
	   TB04014_CODFOR CodCli,
	   ISNULL(ISNULL(VW04008.TB01001_NOME, TB01009_NOME), TB01017_NOME) Cliente,
	   A.TB00012_ESTADO Estado,
	   A.TB00012_Cidade Cidade,
	   NULL Nível,
	   NULL GrupoEconomico,
	   VW04008.TB04001_NOME TipDoc,
	   'Não' Duvidoso,
	   TB04004_NOME Centro,
	   TB04005_NOME Subcentro,
	   TB04014_DTVENC VencimentoOriginal,
	   TB04014_DTVENC Vencimento,
	   YEAR(TB04014_DTVENC) Ano,
	   TB04014_VLRBRUTO ValorBruto,
	   TB04014_VLRACRES ValorAcréscimo,
	   TB04014_VLRDESCONTO ValorDesconto,
	   TB04014_VLRTITULO ValorLiquido,
	   0 ValorInadimplência,
	   TB04015_DTBAIXA DataBaixa,
	   TB04014_VLRPAGO ValorPago,
	   NULL Vendedor,
	   'Pagar' Tipo,
	   'Competência' TipoRegime,   
	   CASE WHEN TB04014_PROVISAO = 'S' THEN 'Sim' ELSE 'Não' END Previsão,
	   TB04008_NOME Banco
  FROM VW04008
LEFT JOIN TB00012 A ON TB00012_CODIGO = VW04008.TB04014_CODFOR
				 AND TB00012_TABELA = CASE WHEN TB04014_OPERACAO IN (1, 2) THEN 'TB01001' WHEN
									            TB04014_OPERACAO = 3 THEN 'TB01009' WHEN
												TB04014_OPERACAO = 4 THEN 'TB01017' END
				 AND TB00012_TIPO = '01'
 WHERE TB04014_VLRTITULO > 0

UNION

SELECT TB04010_CODIGO Titulo,
	   TB04010_CODEMP Codemp,
	   TB01007_NOME Empresa,
	   TB04011_DTBAIXA Data,
	   FORMAT(TB04011_DTBAIXA, 'yyyy-MM') MêsAjustado,
	   TB04010_CODCLI CodCli,
	   VW04004.TB01008_NOME Cliente,
	   TB00012_ESTADO Estado,
	   TB00012_Cidade Cidade,
	   TB01019_NOME Nível,
	   dbo.TB01107.TB01107_NOME GrupoEconomico,
	   VW04004.TB04003_NOME TipDoc,
	   CASE WHEN TIPDOC.TB04003_DUVIDOSO = 'S' THEN 'Sim' ELSE 'Não' END Duvidoso,
	   TB04004_NOME Centro,
	   TB04005_NOME Subcentro,
	   TB04010_DTVENCORIGINAL VencimentoOriginal,
	   TB04010_DTVENC + TIPDOC.TB04003_NUMERO_DIAS Vencimento,
	   YEAR(TB04010_DTVENC + TIPDOC.TB04003_NUMERO_DIAS) Ano,
	   TB04010_VLRBRUTO ValorBruto,
	   TB04010_VLRACRES ValorAcréscimo,
	   TB04010_VLRDESCONTO ValorDesconto,
	   TB04010_VLRPAGO ValorLiquido,
	   CASE WHEN TB04011_DTBAIXA IS NULL AND CAST(GETDATE() as date) > CAST(TB04010_DTVENC + TIPDOC.TB04003_NUMERO_DIAS + 2 as date) THEN TB04010_VLRTITULO ELSE 0 END ValorInadimplência,
	   TB04011_DTBAIXA DataBaixa,
	   TB04010_VLRPAGO ValorPago,
	   VW04004.TB01006_NOME Vendedor,
	   'Receber' Tipo,
	   'Caixa' TipoRegime,
	   NULL Previsão,
	   TB04008_NOME Banco
  FROM VW04004
LEFT JOIN TB01008 AS CLI2 ON CLI2.TB01008_CODIGO = TB04010_CODCLI
LEFT JOIN TB01019 ON TB01019_CODIGO = CLI2.TB01008_NIVEL
LEFT JOIN TB01107 ON TB01107_CODIGO = CLI2.TB01008_GRUPO
LEFT JOIN TB00012 ON TB00012_CODIGO = VW04004.TB04010_CODCLI
				 AND TB00012_TABELA = 'TB01008'
				 AND TB00012_TIPO = '01'
LEFT JOIN TB04003 AS TIPDOC ON TIPDOC.TB04003_CODIGO = TB04010_TIPDOC
  WHERE TB04011_DTBAIXA IS NOT NULL
    AND TB04010_VLRPAGO > 0
	AND TB04010_VLRTITULO > 0

UNION

SELECT TB04014_CODIGO Titulo,
	   TB04014_CODEMP Codemp,
	   TB01007_NOME Empresa,
	   TB04015_DTBAIXA Data,
	   FORMAT(TB04015_DTBAIXA, 'yyyy-MM') MêsAjustado,
	   TB04014_CODFOR CodCli,
	   ISNULL(ISNULL(VW04008.TB01001_NOME, TB01009_NOME), TB01017_NOME) Cliente,
	   A.TB00012_ESTADO Estado,
	   A.TB00012_Cidade Cidade,
	   NULL Nível,
	   NULL GrupoEconomico,
	   VW04008.TB04001_NOME TipDoc,
	   'Não' Duvidoso,
	   TB04004_NOME Centro,
	   TB04005_NOME Subcentro,
	   TB04014_DTVENC VencimentoOriginal,
	   TB04014_DTVENC Vencimento,
	   YEAR(TB04014_DTVENC) Ano,
	   TB04014_VLRBRUTO ValorBruto,
	   TB04014_VLRACRES ValorAcréscimo,
	   TB04014_VLRDESCONTO ValorDesconto,
	   TB04014_VLRPAGO ValorLiquido,
	   0 ValorInadimplência,
	   TB04015_DTBAIXA DataBaixa,
	   TB04014_VLRPAGO ValorPago,
	   NULL Vendedor,
	   'Pagar' Tipo,
	   'Caixa' TipoRegime,
	   CASE WHEN TB04014_PROVISAO = 'S' THEN 'Sim' ELSE 'Não' END Previsão,
	   TB04008_NOME Banco
  FROM VW04008
LEFT JOIN TB00012 A ON TB00012_CODIGO = VW04008.TB04014_CODFOR
				 AND TB00012_TABELA = CASE WHEN TB04014_OPERACAO IN (1, 2) THEN 'TB01001' WHEN
									            TB04014_OPERACAO = 3 THEN 'TB01009' WHEN
												TB04014_OPERACAO = 4 THEN 'TB01017' END
				 AND TB00012_TIPO = '01'
 WHERE TB04015_DTBAIXA IS NOT NULL
   AND TB04014_VLRPAGO > 0
   AND TB04014_VLRTITULO > 0

UNION

SELECT TB04010_CODIGO Titulo,
	   TB04010_CODEMP Codemp,
	   TB01007_NOME Empresa,
	   TB04010_DTVENC Data,
	   FORMAT(TB04010_DTVENC, 'yyyy-MM') MêsAjustado,
	   TB04010_CODCLI CodCli,
	   VW04004.TB01008_NOME Cliente,
	   TB00012_ESTADO Estado,
	   TB00012_Cidade Cidade,
	   TB01019_NOME Nível,
	   dbo.TB01107.TB01107_NOME GrupoEconomico,
	   VW04004.TB04003_NOME TipDoc,
	   CASE WHEN TIPDOC.TB04003_DUVIDOSO = 'S' THEN 'Sim' ELSE 'Não' END Duvidoso,
	   TB04004_NOME Centro,
	   TB04005_NOME Subcentro,
	   TB04010_DTVENCORIGINAL VencimentoOriginal,
	   TB04010_DTVENC + TIPDOC.TB04003_NUMERO_DIAS Vencimento,
	   YEAR(TB04010_DTVENC + TIPDOC.TB04003_NUMERO_DIAS) Ano,
	   TB04010_VLRBRUTO ValorBruto,
	   TB04010_VLRACRES ValorAcréscimo,
	   TB04010_VLRDESCONTO ValorDesconto,
	   TB04010_VLRTITULO ValorLiquido,
	   CASE WHEN TB04011_DTBAIXA IS NULL AND CAST(GETDATE() as date) > CAST(TB04010_DTVENC + TIPDOC.TB04003_NUMERO_DIAS + 2 as date) THEN TB04010_VLRTITULO ELSE 0 END ValorInadimplência,
	   TB04011_DTBAIXA DataBaixa,
	   TB04010_VLRPAGO ValorPago,
	   VW04004.TB01006_NOME Vendedor,
	   'Receber' Tipo,
	   'Vencimento' TipoRegime,
	   NULL Previsão,
	   TB04008_NOME Banco
  FROM VW04004
LEFT JOIN TB01008 AS CLI2 ON CLI2.TB01008_CODIGO = TB04010_CODCLI
LEFT JOIN TB01107 ON TB01107_CODIGO = CLI2.TB01008_GRUPO
LEFT JOIN TB01019 ON TB01019_CODIGO = CLI2.TB01008_NIVEL
LEFT JOIN TB00012 ON TB00012_CODIGO = VW04004.TB04010_CODCLI
				 AND TB00012_TABELA = 'TB01008'
				 AND TB00012_TIPO = '01'
LEFT JOIN TB04003 AS TIPDOC ON TIPDOC.TB04003_CODIGO = TB04010_TIPDOC
 WHERE TB04010_VLRTITULO > 0

UNION

SELECT TB04014_CODIGO Titulo,
	   TB04014_CODEMP Codemp,
	   TB01007_NOME Empresa,
	   TB04014_DTVENC Data,
	   FORMAT(TB04014_DTVENC, 'yyyy-MM') MêsAjustado,
	   TB04014_CODFOR CodCli,
	   ISNULL(ISNULL(VW04008.TB01001_NOME, TB01009_NOME), TB01017_NOME) Cliente,
	   A.TB00012_ESTADO Estado,
	   A.TB00012_Cidade Cidade,
	   NULL Nível,
	   NULL GrupoEconomico,
	   VW04008.TB04001_NOME TipDoc,
	   'Não' Duvidoso,
	   TB04004_NOME Centro,
	   TB04005_NOME Subcentro,
	   TB04014_DTVENC VencimentoOriginal,
	   TB04014_DTVENC Vencimento,
	   YEAR(TB04014_DTVENC) Ano,
	   TB04014_VLRBRUTO ValorBruto,
	   TB04014_VLRACRES ValorAcréscimo,
	   TB04014_VLRDESCONTO ValorDesconto,
	   TB04014_VLRTITULO ValorLiquido,
	   0 ValorInadimplência,
	   TB04015_DTBAIXA DataBaixa,
	   TB04014_VLRPAGO ValorPago,
	   NULL Vendedor,
	   'Pagar' Tipo,
	   'Vencimento' TipoRegime,  
	   CASE WHEN TB04014_PROVISAO = 'S' THEN 'Sim' ELSE 'Não' END Previsão,
	   TB04008_NOME Banco
  FROM VW04008
LEFT JOIN TB00012 A ON TB00012_CODIGO = VW04008.TB04014_CODFOR
				 AND TB00012_TABELA = CASE WHEN TB04014_OPERACAO IN (1, 2) THEN 'TB01001' WHEN
									            TB04014_OPERACAO = 3 THEN 'TB01009' WHEN
												TB04014_OPERACAO = 4 THEN 'TB01017' END
				 AND TB00012_TIPO = '01'
 WHERE TB04014_VLRTITULO > 0

GO

