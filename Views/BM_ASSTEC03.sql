USE [DATACLASSIC]
GO

/****** Object:  View [dbo].[BM_ASSTEC03]    Script Date: 05/03/2024 08:29:54 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE VIEW [dbo].[BM_ASSTEC03] AS

SELECT TB02115_CODIGO OS, 
	   CASE 
		WHEN TB02115_PREVENTIVA = 'I' THEN 'Instalação' 
		WHEN TB02115_PREVENTIVA = 'N' THEN 'Normal' 
		WHEN TB02115_PREVENTIVA = 'D' THEN 'Desinstalação' 
		WHEN TB02115_PREVENTIVA = 'S' THEN 'Preventiva' 
		WHEN TB02115_PREVENTIVA = 'R' THEN 'Retorno / Recarga' 
		ELSE 'Aferição' END Tipo,

	   CASE TB02111_TIPOCONTR 
		WHEN 'A' THEN 'Avulso' 
		WHEN 'G' THEN 'Garantia' 
		WHEN 'M' THEN 'Manutenção' 
		WHEN 'L' THEN 'Locação' END TipoContrato,

	   TB02115_CODEMP Codemp,
	   TB01007_NOME Empresa,
	   TB02115_DATA [Data],
	   SUBSTRING(CONVERT(VARCHAR(10),TB02115_DATA, 103), 1, 10) DataB,
	   SUBSTRING(CONVERT(VARCHAR(10),TB02115_DATA, 103), 7, 4) + '-' + SUBSTRING(CONVERT(VARCHAR(10),TB02115_DATA, 103), 4, 2) AnoMes,
	   SUBSTRING(CONVERT(VARCHAR(10),TB02115_DTFECHA, 103), 7, 4) + '-' + SUBSTRING(CONVERT(VARCHAR(10),TB02115_DTFECHA, 103), 4, 2) AnoMesFechamento,
	   TB02115_CODCLI CodCli,
	   TB01008_NOME Cliente,
	   TB02115_CONTRATO Contrato,
	   TB02111_NOME Classificação,
	   TB02115_NUMSERIE Serie,
	   TB02112_PAT Patromônio,
	   TB01010_NOME Equipamento, 
	   
	   VW02095.TB02115_CODTEC CodTec,
	   ISNULL(ISNULL(CASE WHEN TB02115_TIPOINTERV = 'I' THEN TECFECH.TB01024_NOME ELSE PRESTFECH.TB01017_NOME END, VW02095.TB01024_NOME), 'OS sem técnico vinculado') Tecnico,
       CALC_PREVISAO SLA,
	   CALC_RESTANTE Previsao,
       CASE WHEN CALC_RESTANTE < 0 THEN 1 ELSE 0 END SLA_Excedido,
	   CAST(TB02115_DTFECHA as date) DataFechamento,
       TB01073_NOME [Status],
	   CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAINI + ':00' as datetime) DataHoraIniTIME,
	   CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime) DataHoraFimTIME,

	   CONVERT( VARCHAR(20), DATEDIFF(MI, 
										 CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAINI + ':00' as datetime),
										 CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime)
									  ) / 60) + ':' + RIGHT(REPLICATE('0', 2) + CONVERT(VARCHAR(10), DATEDIFF(MI,
																												 CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAINI + ':00' as datetime),
																												 CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime)
																											  ) % 60), 2) TesteProduzido,
	   DATEDIFF(MI, 
										 CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAINI + ':00' as datetime),
										 CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime)
									  ) ProdSegundos,
	   
	   --CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + CASE WHEN dbo.TB02122.TB02122_HRDESLOC = '' THEN '00:00' WHEN dbo.TB02122.TB02122_HRDESLOC IS NULL THEN '00:00' ELSE dbo.TB02122.TB02122_HRDESLOC END + ':00' as datetime) DeslocTeste,
	   --DATEDIFF(SECOND, CAST(CAST(CAST(TB02115_DATA as date) as varchar) + ' 00:00:00' as datetime),  CAST(CAST(CAST(TB02115_DATA as date) as varchar) + ' ' + CASE WHEN dbo.TB02122.TB02122_HRDESLOC = '' THEN '00:00' WHEN dbo.TB02122.TB02122_HRDESLOC IS NULL THEN '00:00' ELSE dbo.TB02122.TB02122_HRDESLOC END + ':00' as datetime)) DeslocSegundos,
	   TB02112_HORAS SLA_Contrato,
	  (SELECT ISNULL(SUM(TB02125_TOTVALOR), 0)
	     FROM TB02125
		WHERE TB02125_CODIGO = VW02095.TB02122_CODIGO) ValorServicos,
	  (SELECT ISNULL(SUM(TB02124_CUSTO) ,0)
	     FROM TB02124
		WHERE TB02124_CODIGO = VW02095.TB02122_CODIGO) ValorPecasTrocadas,
	   --ISNULL(CONVERT(VARCHAR(5), CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + CASE WHEN SUBSTRING(dbo.TB02122.TB02122_HRDESLOC, 1, 5) = '' THEN '00:00' WHEN SUBSTRING(dbo.TB02122.TB02122_HRDESLOC, 1, 5) IS NULL THEN '00:00' ELSE SUBSTRING(dbo.TB02122.TB02122_HRDESLOC, 1, 5) END + ':00' as datetime), 108), '00:00') Deslocamento,
	   CASE WHEN TB02115_REINCIDENCIA = 'S' THEN 1 ELSE 0 END Reincidência,
	   
	   --CASE WHEN DATEDIFF(D, (SELECT TOP 1 dbo.TB02115.TB02115_DATA FROM TB02115 WHERE dbo.TB02115.TB02115_NUMSERIE = VW02095.TB02115_NUMSERIE AND CAST(dbo.TB02115.TB02115_CODIGO as int) < CAST(VW02095.TB02115_CODIGO as int) ORDER BY dbo.TB02115.TB02115_DATA DESC), VW02095.TB02115_DATA) >= 30 THEN 0 ELSE 1 END Retorno,
	   	-- NOVO RETORNO QUANDO UMA NOVA OS E ABERTA COM PRAZO DE MENOS DE 15 DIAS e COM MESMO DEFEITO
		CASE 
			WHEN DATEDIFF(D, (SELECT TOP 1 dbo.TB02115.TB02115_DATA 
							  FROM TB02115 
							  WHERE dbo.TB02115.TB02115_NUMSERIE = VW02095.TB02115_NUMSERIE AND CAST(dbo.TB02115.TB02115_CODIGO as int) < CAST(VW02095.TB02115_CODIGO as int) 
							  ORDER BY dbo.TB02115.TB02115_DATA DESC), VW02095.TB02115_DATA) < 30  
							  AND TB02115_PREVENTIVA = 'N' 
							  AND VW02095.TB02115_NOME = (SELECT TOP 1 dbo.TB02115.TB02115_NOME 
														  FROM TB02115 
														  WHERE dbo.TB02115.TB02115_NUMSERIE = VW02095.TB02115_NUMSERIE AND CAST(dbo.TB02115.TB02115_CODIGO as int) < CAST(VW02095.TB02115_CODIGO as int) 
														  ORDER BY dbo.TB02115.TB02115_DATA DESC) THEN 1
			ELSE 0 
		END Retorno,
	   
	   
	   VW02095.TB02122_CODIGO CodFech,
	   TB02112_CIDADE Cidade,
	   TB02112_ESTADO Estado,
	   VW02095.TB02176_NOME [Site],
	   VW02095.TB02177_NOME Departamento,
	   CAST(ISNULL(dbo.TB02122.TB02122_KMFINAL, 0) - ISNULL(dbo.TB02122.TB02122_KMINICIAL, 0) as numeric(11,3)) KMSaldo,
	   CAST(CASE WHEN ISNULL(dbo.TB02122.TB02122_KMFINAL, 0) - ISNULL(dbo.TB02122.TB02122_KMINICIAL, 0) = 0 THEN 0 ELSE ISNULL(dbo.TB02122.TB02122_KMFINAL, 0) - ISNULL(dbo.TB02122.TB02122_KMINICIAL, 0) * 0.028 END  as int) TempoDeslocSeg,
	   dbo.TB02122.TB02122_PLACA Placa,
	  (SELECT TOP 1 TB01048_NOME FROM TB01048 LEFT JOIN TB02116 ON TB02116_DEFEITO = TB01048_CODIGO WHERE TB02116_CODIGO = VW02095.TB02115_CODIGO) Defeito,
	  ISNULL(TB02122.TB02122_CONTADOR, 0) MedidorPB,
	  ISNULL(TB02122.TB02122_CONTADORC, 0) MedidorCor,
	  ISNULL(TB02122.TB02122_CONTADORGF, 0) MedidorA3PB,
	  ISNULL(TB02122.TB02122_CONTADORGFC, 0) MedidorA3Cor,
	  ISNULL(TB02122.TB02122_CONTADORDG, 0) MedidorA3DG,
	  TB01055_NOME CondIntervencao,
	  1 Qtde,
	  ISNULL(CAST(TECFECH.TB01024_OBS as varchar(20)), 'Sem equipe no cadastro') Equipe,
	 --(SELECT (ISNULL(DATEDIFF(SS, BM_ASSTEC04.[Hora1], BM_ASSTEC04.[Hora2]), 0) + ISNULL(DATEDIFF(SS, BM_ASSTEC04.[Hora3], BM_ASSTEC04.[Hora4]), 0))
		--/ (SELECT SUM(QTDEOS) FROM BM_ASSTEC_TECDAT WHERE CODTEC = VW02095.TB02115_CODTEC AND [DATA] = CAST(VW02095.TB02115_DATA AS DATE))
	 --   FROM BM_ASSTEC04
	 --  WHERE [Data] = CAST(TB02115_DATA as date)
	 --    AND CodTec = VW02095.TB02115_CODTEC) TempoPontoSeg,
	 ISNULL((SELECT prodseg
	    FROM BM_PRODTEC
	   WHERE [data] = cast(VW02095.TB02115_DATA as date)
	     AND codtec = VW02095.TB02115_CODTEC), 0) TempoPontoSeg,
	   DATEDIFF(SS, TB02115_DATA, CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAINI + ':00' as datetime)) RespSlaSeg,
	   DATEDIFF(SS, TB02115_DATA, CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime)) RespTecSlaSeg,
	   DATEDIFF(SS, CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAINI + ':00' as datetime), CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime)) RespMediaTec
  FROM VW02095
LEFT JOIN TB02122 ON dbo.TB02122.TB02122_NUMOS = VW02095.TB02115_CODIGO
				 AND dbo.TB02122.TB02122_CODCLI = VW02095.TB02115_CODCLI
				 AND dbo.TB02122.TB02122_CONTRATO = VW02095.TB02115_CONTRATO
				 AND dbo.TB02122.TB02122_NUMSERIE = VW02095.TB02115_NUMSERIE
LEFT JOIN TB01024 AS TECFECH ON TECFECH.TB01024_CODIGO = dbo.TB02122.TB02122_CODTEC
LEFT JOIN TB01017 AS PRESTFECH ON PRESTFECH.TB01017_CODIGO = dbo.TB02122.TB02122_PREST
 WHERE TB02115_situacao = 'A'
   AND TB02115_DTFECHA IS NOT NULL
   AND YEAR(TB02115_DTFECHA) > 2017
GO

