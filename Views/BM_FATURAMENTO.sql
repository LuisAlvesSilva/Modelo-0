USE [DATACLASSIC]
GO

/****** Object:  View [dbo].[BM_FATURAMENTO]    Script Date: 26/02/2024 09:46:23 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE VIEW [dbo].[BM_FATURAMENTO]
AS
/* PEDIDOS DE VENDA */
SELECT dbo.TB02022.TB02022_CODIGO AS Pedido,
	   TB01007_NOME Empresa,
	   TB02021_CODEMP Codemp,
	   dbo.TB02021.TB02021_DATA AS Data,
	   dbo.TB02021.TB02021_CODCLI CodCli,
	   dbo.TB01008.TB01008_NOME AS Cliente,
	   dbo.TB02022.TB02022_PRODUTO AS CodProduto, 
	   dbo.TB01010.TB01010_REFERENCIA Referência,
	   dbo.TB01010.TB01010_NOME AS Produto,
	   TB01047_NOME	Marca,
	   TB01002_NOME Grupo,
	   TB01018_NOME Subgrupo,
	   dbo.TB02022.TB02022_QTPROD AS Qtde,

	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) AS CustoCompra,
	   
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) AS ValorFrete, 

       CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) AS ValorPIS, 
       CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) AS ValorCOFINS, 
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01110_IR END / 100 ELSE 0 END AS numeric(11, 2)) AS ValorIR,
       CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01110_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) AS ValorCSLL, 
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) ValorICMS,
	   CAST(TB02022_VLRST as numeric(11,2)) ValorST,

	   ISNULL(TB02022_VLRIPI, 0) ValorIPI,

	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) AS ValorTotal,

	   --cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   --(
	   --CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   --ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   --CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   --CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   --CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   --CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   --(CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   --ISNULL(TB02022_VLRIPI, 0) +
	   --CAST((TB02022_TOTVALOR - ((TB02022_TOTVALOR * CASE WHEN TB01014_A.TB01014_TIPOPERC = 0 THEN TB02021.TB02021_PERCCOND ELSE 0 END)/100)) * TB02022_COMISSAO/100 AS NUMERIC(11,2)) +
	   --ISNULL(TB02022_VLROUTDESP, 0) +
	   --CAST(SUM(((TB02022_TOTVALOR + TB02022_VLRIPI + TB02022_VLRST + TB02022_VLRFRETE + TB02022_VLROUTDESP)) * CASE WHEN TB01014_A.TB01014_TIPOPERC = 0 THEN TB02021_PERCCOND ELSE (TB02021_PERCCOND * -1) END/100) as numeric(11,2))
	   --) Lucro,
	    
	   -- Venda
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   -- Custo
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) -
	   -- Juros
	   CAST(SUM(((TB02022_TOTVALOR + TB02022_VLRIPI + TB02022_VLRST + TB02022_VLRFRETE + TB02022_VLROUTDESP)) * CASE WHEN TB01014_A.TB01014_TIPOPERC = 0 THEN TB02021_PERCCOND ELSE (TB02021_PERCCOND * -1) END/100) as numeric(11,2)) -
	   -- ICMS
	   CAST((CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) as numeric(11,2)) -
	   -- PIS
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) - 
	   -- COFINS
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) - 
	   -- CSLL
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) -
	   -- IR
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) - 
	   -- IPI
	   CAST(ISNULL(TB02022_VLRIPI, 0) as numeric(11,2)) -
	   -- ST
	   CAST(TB02022_VLRST as numeric(11,2)) - 
	   -- Comissão
	   CAST((TB02022_TOTVALOR - ((TB02022_TOTVALOR * CASE WHEN TB01014_A.TB01014_TIPOPERC = 0 THEN TB02021.TB02021_PERCCOND ELSE 0 END)/100)) * TB02022_COMISSAO/100 AS NUMERIC(11,2)) -
	   -- Frete
	   CAST(ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) as numeric(11,2)) -
	   -- Outras
	   CAST(ISNULL(TB02022_VLROUTDESP, 0) as numeric(11,2)) AS Lucro,

	   CAST(SUM(((TB02022_TOTVALOR + TB02022_VLRIPI + TB02022_VLRST + TB02022_VLRFRETE + TB02022_VLROUTDESP)) * CASE WHEN TB01014_A.TB01014_TIPOPERC = 0 THEN TB02021_PERCCOND ELSE (TB02021_PERCCOND * -1) END/100) as numeric(11,2)) Juros,


	   ISNULL(TB02022_VLROUTDESP, 0) ValorOutras,
	   CAST((TB02022_TOTVALOR - ((TB02022_TOTVALOR * CASE WHEN TB01014_A.TB01014_TIPOPERC = 0 THEN TB02021.TB02021_PERCCOND ELSE 0 END)/100)) * TB02022_COMISSAO/100 AS NUMERIC(11,2)) Comissão,
	   
	   dbo.TB02021.TB02021_VEND CodVend,
	   dbo.TB01006.TB01006_NOME AS Vendedor,
	   TB00012_ESTADO UF,
	   TB00012_CIDADE Cidade,
	   TB01019_NOME Nível,
	   TB01022_NOME Operação,
	   TB02021_CODCEN CodCentro,
	   TB04004_NOME Centro,
	   TB02021_CODSUB CodSubcentro,
	   TB04005_NOME Subcentro,

	   /*** Positivação Clientes ***/
	   CASE WHEN MONTH(TB02021_DATA) = 1  THEN COUNT(DISTINCT TB02021_CODCLI) ELSE 0 END CliPos01,
	   CASE WHEN MONTH(TB02021_DATA) = 2  THEN COUNT(DISTINCT TB02021_CODCLI) ELSE 0 END CliPos02,
	   CASE WHEN MONTH(TB02021_DATA) = 3  THEN COUNT(DISTINCT TB02021_CODCLI) ELSE 0 END CliPos03,
	   CASE WHEN MONTH(TB02021_DATA) = 4  THEN COUNT(DISTINCT TB02021_CODCLI) ELSE 0 END CliPos04,
	   CASE WHEN MONTH(TB02021_DATA) = 5  THEN COUNT(DISTINCT TB02021_CODCLI) ELSE 0 END CliPos05,
	   CASE WHEN MONTH(TB02021_DATA) = 6  THEN COUNT(DISTINCT TB02021_CODCLI) ELSE 0 END CliPos06,
	   CASE WHEN MONTH(TB02021_DATA) = 7  THEN COUNT(DISTINCT TB02021_CODCLI) ELSE 0 END CliPos07,
	   CASE WHEN MONTH(TB02021_DATA) = 8  THEN COUNT(DISTINCT TB02021_CODCLI) ELSE 0 END CliPos08,
	   CASE WHEN MONTH(TB02021_DATA) = 9  THEN COUNT(DISTINCT TB02021_CODCLI) ELSE 0 END CliPos09,
	   CASE WHEN MONTH(TB02021_DATA) = 10 THEN COUNT(DISTINCT TB02021_CODCLI) ELSE 0 END CliPos10,
	   CASE WHEN MONTH(TB02021_DATA) = 11 THEN COUNT(DISTINCT TB02021_CODCLI) ELSE 0 END CliPos11,
	   CASE WHEN MONTH(TB02021_DATA) = 12 THEN COUNT(DISTINCT TB02021_CODCLI) ELSE 0 END CliPos12,

	   /*** Positivação Prod ***/
	   CASE WHEN MONTH(TB02021_DATA) = 1  THEN 1 ELSE 0 END ProdPos01,
	   CASE WHEN MONTH(TB02021_DATA) = 2  THEN 1 ELSE 0 END ProdPos02,
	   CASE WHEN MONTH(TB02021_DATA) = 3  THEN 1 ELSE 0 END ProdPos03,
	   CASE WHEN MONTH(TB02021_DATA) = 4  THEN 1 ELSE 0 END ProdPos04,
	   CASE WHEN MONTH(TB02021_DATA) = 5  THEN 1 ELSE 0 END ProdPos05,
	   CASE WHEN MONTH(TB02021_DATA) = 6  THEN 1 ELSE 0 END ProdPos06,
	   CASE WHEN MONTH(TB02021_DATA) = 7  THEN 1 ELSE 0 END ProdPos07,
	   CASE WHEN MONTH(TB02021_DATA) = 8  THEN 1 ELSE 0 END ProdPos08,
	   CASE WHEN MONTH(TB02021_DATA) = 9  THEN 1 ELSE 0 END ProdPos09,
	   CASE WHEN MONTH(TB02021_DATA) = 10 THEN 1 ELSE 0 END ProdPos10,
	   CASE WHEN MONTH(TB02021_DATA) = 11 THEN 1 ELSE 0 END ProdPos11,
	   CASE WHEN MONTH(TB02021_DATA) = 12 THEN 1 ELSE 0 END ProdPos12,

	   /*** Positivação Vendedores ***/
	   CASE WHEN MONTH(TB02021_DATA) = 1  THEN COUNT(DISTINCT dbo.TB01006.TB01006_NOME) ELSE 0 END VendPos01,
	   CASE WHEN MONTH(TB02021_DATA) = 2  THEN COUNT(DISTINCT dbo.TB01006.TB01006_NOME) ELSE 0 END VendPos02,
	   CASE WHEN MONTH(TB02021_DATA) = 3  THEN COUNT(DISTINCT dbo.TB01006.TB01006_NOME) ELSE 0 END VendPos03,
	   CASE WHEN MONTH(TB02021_DATA) = 4  THEN COUNT(DISTINCT dbo.TB01006.TB01006_NOME) ELSE 0 END VendPos04,
	   CASE WHEN MONTH(TB02021_DATA) = 5  THEN COUNT(DISTINCT dbo.TB01006.TB01006_NOME) ELSE 0 END VendPos05,
	   CASE WHEN MONTH(TB02021_DATA) = 6  THEN COUNT(DISTINCT dbo.TB01006.TB01006_NOME) ELSE 0 END VendPos06,
	   CASE WHEN MONTH(TB02021_DATA) = 7  THEN COUNT(DISTINCT dbo.TB01006.TB01006_NOME) ELSE 0 END VendPos07,
	   CASE WHEN MONTH(TB02021_DATA) = 8  THEN COUNT(DISTINCT dbo.TB01006.TB01006_NOME) ELSE 0 END VendPos08,
	   CASE WHEN MONTH(TB02021_DATA) = 9  THEN COUNT(DISTINCT dbo.TB01006.TB01006_NOME) ELSE 0 END VendPos09,
	   CASE WHEN MONTH(TB02021_DATA) = 10 THEN COUNT(DISTINCT dbo.TB01006.TB01006_NOME) ELSE 0 END VendPos10,
	   CASE WHEN MONTH(TB02021_DATA) = 11 THEN COUNT(DISTINCT dbo.TB01006.TB01006_NOME) ELSE 0 END VendPos11,
	   CASE WHEN MONTH(TB02021_DATA) = 12 THEN COUNT(DISTINCT dbo.TB01006.TB01006_NOME) ELSE 0 END VendPos12,

	   /*** Positivação Cidade ***/
	   CASE WHEN MONTH(TB02021_DATA) = 1  THEN COUNT(DISTINCT TB00012_CIDADE) ELSE 0 END CidadePos01,
	   CASE WHEN MONTH(TB02021_DATA) = 2  THEN COUNT(DISTINCT TB00012_CIDADE) ELSE 0 END CidadePos02,
	   CASE WHEN MONTH(TB02021_DATA) = 3  THEN COUNT(DISTINCT TB00012_CIDADE) ELSE 0 END CidadePos03,
	   CASE WHEN MONTH(TB02021_DATA) = 4  THEN COUNT(DISTINCT TB00012_CIDADE) ELSE 0 END CidadePos04,
	   CASE WHEN MONTH(TB02021_DATA) = 5  THEN COUNT(DISTINCT TB00012_CIDADE) ELSE 0 END CidadePos05,
	   CASE WHEN MONTH(TB02021_DATA) = 6  THEN COUNT(DISTINCT TB00012_CIDADE) ELSE 0 END CidadePos06,
	   CASE WHEN MONTH(TB02021_DATA) = 7  THEN COUNT(DISTINCT TB00012_CIDADE) ELSE 0 END CidadePos07,
	   CASE WHEN MONTH(TB02021_DATA) = 8  THEN COUNT(DISTINCT TB00012_CIDADE) ELSE 0 END CidadePos08,
	   CASE WHEN MONTH(TB02021_DATA) = 9  THEN COUNT(DISTINCT TB00012_CIDADE) ELSE 0 END CidadePos09,
	   CASE WHEN MONTH(TB02021_DATA) = 10 THEN COUNT(DISTINCT TB00012_CIDADE) ELSE 0 END CidadePos10,
	   CASE WHEN MONTH(TB02021_DATA) = 11 THEN COUNT(DISTINCT TB00012_CIDADE) ELSE 0 END CidadePos11,
	   CASE WHEN MONTH(TB02021_DATA) = 12 THEN COUNT(DISTINCT TB00012_CIDADE) ELSE 0 END CidadePos12,

	   /*** CMV ***/
	   CASE WHEN MONTH(TB02021_DATA) = 1  THEN CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) ELSE 0 END CustoCompra01,
	   CASE WHEN MONTH(TB02021_DATA) = 2  THEN CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) ELSE 0 END CustoCompra02,
	   CASE WHEN MONTH(TB02021_DATA) = 3  THEN CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) ELSE 0 END CustoCompra03,
	   CASE WHEN MONTH(TB02021_DATA) = 4  THEN CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) ELSE 0 END CustoCompra04,
	   CASE WHEN MONTH(TB02021_DATA) = 5  THEN CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) ELSE 0 END CustoCompra05,
	   CASE WHEN MONTH(TB02021_DATA) = 6  THEN CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) ELSE 0 END CustoCompra06,
	   CASE WHEN MONTH(TB02021_DATA) = 7  THEN CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) ELSE 0 END CustoCompra07,
	   CASE WHEN MONTH(TB02021_DATA) = 8  THEN CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) ELSE 0 END CustoCompra08,
	   CASE WHEN MONTH(TB02021_DATA) = 9  THEN CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) ELSE 0 END CustoCompra09,
	   CASE WHEN MONTH(TB02021_DATA) = 10 THEN CAST(dbO.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) ELSE 0 END CustoCompra10,
	   CASE WHEN MONTH(TB02021_DATA) = 11 THEN CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) ELSE 0 END CustoCompra11,
	   CASE WHEN MONTH(TB02021_DATA) = 12 THEN CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) ELSE 0 END CustoCompra12,

	   /*** Valor Total ***/
	   CASE WHEN MONTH(TB02021_DATA) = 1  THEN cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) ELSE 0 END AS ValorTotal01,
	   CASE WHEN MONTH(TB02021_DATA) = 2  THEN cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) ELSE 0 END AS ValorTotal02,
	   CASE WHEN MONTH(TB02021_DATA) = 3  THEN cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) ELSE 0 END AS ValorTotal03,
	   CASE WHEN MONTH(TB02021_DATA) = 4  THEN cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) ELSE 0 END AS ValorTotal04,
	   CASE WHEN MONTH(TB02021_DATA) = 5  THEN cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) ELSE 0 END AS ValorTotal05,
	   CASE WHEN MONTH(TB02021_DATA) = 6  THEN cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) ELSE 0 END AS ValorTotal06,
	   CASE WHEN MONTH(TB02021_DATA) = 7  THEN cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) ELSE 0 END AS ValorTotal07,
	   CASE WHEN MONTH(TB02021_DATA) = 8  THEN cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) ELSE 0 END AS ValorTotal08,
	   CASE WHEN MONTH(TB02021_DATA) = 9  THEN cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) ELSE 0 END AS ValorTotal09,
	   CASE WHEN MONTH(TB02021_DATA) = 10 THEN cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) ELSE 0 END AS ValorTotal10,
	   CASE WHEN MONTH(TB02021_DATA) = 11 THEN cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) ELSE 0 END AS ValorTotal11,
	   CASE WHEN MONTH(TB02021_DATA) = 12 THEN cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) ELSE 0 END AS ValorTotal12,

	   /*** Lucratividade ***/
	   CASE WHEN MONTH(TB02021_DATA) = 1  THEN 
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   (
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   ISNULL(TB02022_VLRIPI, 0) +
	   dbo.FS02015(TB02022.TB02022_CODIGO, TB02022.TB02022_PRODUTO,1)
	   ) ELSE 0 END Lucro01,

	   CASE WHEN MONTH(TB02021_DATA) = 2  THEN 
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   (
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   ISNULL(TB02022_VLRIPI, 0) +
	   dbo.FS02015(TB02022.TB02022_CODIGO, TB02022.TB02022_PRODUTO,1)
	   ) ELSE 0 END Lucro02,

	   CASE WHEN MONTH(TB02021_DATA) = 3  THEN 
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   (
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   ISNULL(TB02022_VLRIPI, 0) +
	   dbo.FS02015(TB02022.TB02022_CODIGO, TB02022.TB02022_PRODUTO,1)
	   ) ELSE 0 END Lucro03,

	   CASE WHEN MONTH(TB02021_DATA) = 4  THEN 
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   (
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   ISNULL(TB02022_VLRIPI, 0) +
	   dbo.FS02015(TB02022.TB02022_CODIGO, TB02022.TB02022_PRODUTO,1)
	   ) ELSE 0 END Lucro04,

	   CASE WHEN MONTH(TB02021_DATA) = 5  THEN 
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   (
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   ISNULL(TB02022_VLRIPI, 0) +
	   dbo.FS02015(TB02022.TB02022_CODIGO, TB02022.TB02022_PRODUTO,1)
	   ) ELSE 0 END Lucro05,

	   CASE WHEN MONTH(TB02021_DATA) = 6  THEN 
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   (
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   ISNULL(TB02022_VLRIPI, 0) +
	   dbo.FS02015(TB02022.TB02022_CODIGO, TB02022.TB02022_PRODUTO,1)
	   ) ELSE 0 END Lucro06,

	   CASE WHEN MONTH(TB02021_DATA) = 7  THEN 
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   (
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   ISNULL(TB02022_VLRIPI, 0) +
	   dbo.FS02015(TB02022.TB02022_CODIGO, TB02022.TB02022_PRODUTO,1)
	   ) ELSE 0 END Lucro07,

	   CASE WHEN MONTH(TB02021_DATA) = 8  THEN 
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   (
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   ISNULL(TB02022_VLRIPI, 0) +
	   dbo.FS02015(TB02022.TB02022_CODIGO, TB02022.TB02022_PRODUTO,1)
	   ) ELSE 0 END Lucro08,

	   CASE WHEN MONTH(TB02021_DATA) = 9  THEN 
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   (
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   ISNULL(TB02022_VLRIPI, 0) +
	   dbo.FS02015(TB02022.TB02022_CODIGO, TB02022.TB02022_PRODUTO,1)
	   ) ELSE 0 END Lucro09,

	   CASE WHEN MONTH(TB02021_DATA) = 10  THEN 
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   (
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   ISNULL(TB02022_VLRIPI, 0) +
	   dbo.FS02015(TB02022.TB02022_CODIGO, TB02022.TB02022_PRODUTO,1)
	   ) ELSE 0 END Lucro10,

	   CASE WHEN MONTH(TB02021_DATA) = 11  THEN 
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   (
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   ISNULL(TB02022_VLRIPI, 0) +
	   dbo.FS02015(TB02022.TB02022_CODIGO, TB02022.TB02022_PRODUTO,1)
	   ) ELSE 0 END Lucro11,

	   CASE WHEN MONTH(TB02021_DATA) = 12  THEN 
	   cast((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) + ((TB02022_TOTVALOR + TB02022_VLRST + TB02022_VLRIPI + TB02022_VLRFRETE + TB02022_VLROUTDESP) * ( CASE WHEN TB02021_VLRBRUTO <> 0 THEN (TB02021_VLROVER/TB02021_VLRBRUTO) ELSE 0 END *100)/100) as numeric(11,2)) -
	   (
	   CAST(dbo.TB02022.TB02022_CUSTO * CAST(dbo.TB02022.TB02022_QTPROD AS numeric(11,2)) AS numeric(11,2)) +
	   ISNULL(dbo.TB02022.TB02022_VLRFRETE, 0) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQPIS = 'S' THEN TB01022_ALIQPIS ELSE TB01010_ALIQPIS END / 100 AS numeric(11, 2)) +
	   CAST((dbo.TB02022.TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCOFINS = 'S' THEN TB01022_ALIQCOFINS ELSE TB01010_ALIQCOFINS END / 100 AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCIR = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CIR = 'S' THEN TB01022_IR ELSE TB01010_IR END / 100 ELSE 0 END AS numeric(11, 2)) +
	   CAST(CASE WHEN TB01011_CALCCSLL = 'S' THEN (TB02022_TOTVALOR + CASE WHEN TB01011_INCFRETE = 'S' THEN TB02022_VLRFRETE ELSE 0 END + CASE WHEN TB01011_INCOUTDESP = 'S' THEN TB02022_VLROUTDESP ELSE 0 END + CASE WHEN TB01011_INCIPI = 'S' THEN TB02022_VLRIPI ELSE 0 END + CASE WHEN TB01011_INCST = 'S' THEN TB02022_VLRST ELSE 0 END) * CASE WHEN TB01022_IMPOSTOS = 'S' AND TB01022_CALIQCSLL = 'S' THEN TB01022_ALIQCSLL ELSE TB01010_ALIQCSLL END / 100 ELSE 0 END AS numeric(11, 2)) +
	   (CASE WHEN TB02021.TB02021_CUPOM = 'N' THEN dbo.FS02014(TB02022_CODIGO,TB02022_PRODUTO) + CASE WHEN (TB01007.TB01007_REGIMEES = 'S') THEN TB02022_VLRICMSFORA ELSE 0  END + TB02022_VLRFCP ELSE TB02022_VLRICMSCU END) +
	   ISNULL(TB02022_VLRIPI, 0) +
	   dbo.FS02015(TB02022.TB02022_CODIGO, TB02022.TB02022_PRODUTO,1)
	   ) ELSE 0 END Lucro12,
	   CASE WHEN TB02021_VENDACONS = 'S' THEN 'Consumo' ELSE 'Revenda' END TipoVenda,
	   TB01024_NOME Técnico,
	   TB01107_NOME GrupoEconomico,
	   TB02021_NTFISC NotaFiscal,
	   CAST(dbo.TB02022.TB02022_CUSTO - dbo.TB02022.TB02022_VLRICMSULT AS MONEY) CustoUniProd,
	   CAST(dbo.TB02022.TB02022_VLRICMSULT AS MONEY) IcmsEstorno,
	   TB02021_TIPODESC CodOperacao

  FROM dbo.TB02022 

LEFT OUTER JOIN dbo.TB02021 ON dbo.TB02021.TB02021_CODIGO = dbo.TB02022.TB02022_CODIGO AND dbo.TB02021.TB02021_CODEMP = dbo.TB02022.TB02022_CODEMP AND dbo.TB02021.TB02021_CODCAI = dbo.TB02022.TB02022_CODCAI
LEFT JOIN TB01007 ON TB01007_CODIGO = TB02022_CODEMP
LEFT JOIN TB01014 AS TB01014_A ON TB01014_A.TB01014_CODIGO = TB02021_CONDPAG
LEFT OUTER JOIN dbo.TB01008 ON dbo.TB01008.TB01008_CODIGO = dbo.TB02021.TB02021_CODCLI
LEFT JOIN TB00012 ON TB00012_CODIGO = TB02021_CODCLI AND TB00012_TIPO = '01' AND TB00012_TABELA = 'TB01008'
LEFT JOIN TB01019 ON TB01019_CODIGO = TB01008_NIVEL
LEFT OUTER JOIN dbo.TB01010 ON dbo.TB01010.TB01010_CODIGO = dbo.TB02022.TB02022_PRODUTO
LEFT JOIN TB01047 ON TB01047_CODIGO = TB01010_MARCA
LEFT JOIN TB01002 ON TB01002_CODIGO = TB01010_GRUPO
LEFT JOIN TB01018 ON TB01018_CODIGO = TB01010_SUBGRUPO
LEFT OUTER JOIN dbo.TB01022 ON dbo.TB01022.TB01022_CODIGO = dbo.TB02022.TB02022_TIPODESC
LEFT OUTER JOIN dbo.TB01011 ON dbo.TB01011.TB01011_CODIGO = CASE WHEN TB01022_NATUREZA <> '' AND TB01022_NATUREZA IS NOT NULL THEN TB01022_NATUREZA ELSE TB01010_CFOPDENTRO END
LEFT JOIN TB01006 ON TB01006_CODIGO = TB02021_VEND
LEFT JOIN TB04004 ON TB04004_CODIGO = TB02021_CODCEN
LEFT JOIN TB04005 ON TB04005_CODIGO = TB02021_CODSUB
LEFT JOIN TB01024 ON TB01024_CODIGO = TB02021_CODTEC
LEFT JOIN TB01107 ON TB01107_CODIGO = TB01008_GRUPO
LEFT JOIN TB01110 ON TB01110_PRODUTO = TB02022_PRODUTO
				 AND TB01110_CODEMP = TB02022_CODEMP
  WHERE dbo.TB02021.TB02021_BONIF = 'N'
    /* AND TB02021_VLRSERV = 0 */
    AND TB02021_BONIF = 'N'
    AND TB02021_CUPOM = 'N'
	--AND dbo.TB02022.TB02022_CODIGO = 'V02272'	
		
GROUP BY dbo.TB02022.TB02022_CODIGO,
		     dbo.TB01007.TB01007_CODIGO,
		 dbo.TB02021.TB02021_DATA,
		 dbo.TB01008.TB01008_NOME,
		 dbo.TB02021.TB02021_CODCLI,
		 dbo.TB02022.TB02022_PRODUTO,
		 dbo.TB01010.TB01010_REFERENCIA,
		 dbo.TB01010.TB01010_NOME,
			 TB01047.TB01047_NOME,
			 TB01002.TB01002_NOME,
			 TB01018.TB01018_NOME,
		 dbo.TB02022.TB02022_QTPROD,
		 dbo.TB02022.TB02022_CUSTO,
		 dbo.TB02022.TB02022_VLRFRETE,
		 dbo.TB02022.TB02022_TOTVALOR,
		 dbo.TB01011.TB01011_INCFRETE,
		 dbo.TB01011.TB01011_INCOUTDESP,
		 dbo.TB02022.TB02022_VLROUTDESP,
		 dbo.TB01011.TB01011_INCIPI,
		 dbo.TB02022.TB02022_VLRIPI,
		 dbo.TB01011.TB01011_INCST,
		 dbo.TB02022.TB02022_VLRST,
		 dbo.TB01022.TB01022_IMPOSTOS,
		 dbo.TB01022.TB01022_CALIQPIS,
		 dbo.TB01022.TB01022_ALIQPIS,
		 dbo.TB01010.TB01010_ALIQPIS,
		 dbo.TB01022.TB01022_CALIQCOFINS,
		 dbo.TB01022.TB01022_ALIQCOFINS,
		 dbo.TB01010.TB01010_ALIQCOFINS,
		 dbo.TB01011.TB01011_CALCIR,
		 dbo.TB01022.TB01022_CIR,
		 dbo.TB01022.TB01022_IR,
		 dbo.TB01010.TB01010_IR,
		 dbo.TB01011.TB01011_CALCCSLL,
		 dbo.TB01022.TB01022_CALIQCSLL,
		 dbo.TB01022.TB01022_ALIQCSLL,
		 dbo.TB01010.TB01010_ALIQCSLL,
		 dbo.TB02021.TB02021_CUPOM,
			 TB01007.TB01007_REGIMEES,
		 dbo.TB02022.TB02022_VLRICMSFORA,
		 dbo.TB02022.TB02022_VLRFCP,
		 dbo.TB02022.TB02022_VLRICMSCU,
		 dbo.TB02021.TB02021_VLRBRUTO,
		 dbo.TB02021.TB02021_VLROVER,
		 dbo.TB02021.TB02021_VLRBRUTO,
		 dbo.TB02022.TB02022_PRUNIT,
			 TB01006.TB01006_NOME,
			 dbo.TB02021.TB02021_VEND,
			 TB00012.TB00012_ESTADO,
			 TB00012.TB00012_CIDADE,
			 TB01019.TB01019_NOME,
		 dbo.TB01022.TB01022_NOME,
			 TB04004.TB04004_NOME,
			 TB04005.TB04005_NOME,
			 TB02021.TB02021_VENDACONS,
			 TB01024.TB01024_NOME,
			 TB01014_A.TB01014_TIPOPERC,
			 dbo.TB02021.TB02021_PERCCOND,
			 dbo.TB02022.TB02022_COMISSAO,
			 TB02021_CODCEN,
			 TB02021_CODSUB,
			 TB02021_CODEMP,
			 TB01107.TB01107_NOME, TB01007.TB01007_NOME,
			 TB01110.TB01110_IR, TB01110.TB01110_ALIQCSLL,
			 TB02021_NTFISC,
			 dbo.TB02022.TB02022_VLRICMSULT, dbo.TB02021.TB02021_TIPODESC


GO

