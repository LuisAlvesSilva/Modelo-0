USE [DATACLASSIC]
GO

/****** Object:  View [dbo].[BM_CXFLWBNK]    Script Date: 05/03/2024 08:42:14 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE VIEW [dbo].[BM_CXFLWBNK]
AS
SELECT dbo.TB04009.TB04009_CODEMP AS Codemp,
	   TB01007_NOME Empresa,
	   TB04008_NOME Banco,
	   dbo.TB04009.TB04009_CODIGO AS CodConta,
	   dbo.TB04009.TB04009_NOME AS Conta,
	   
	   CASE WHEN 

	   (SELECT SUM(TB04018_A.TB04018_VALOR)
	      FROM dbo.TB04018 AS TB04018_A
	     WHERE TB04018_A.TB04018_CODCADBANCO = dbo.TB04009.TB04009_CODIGO
		   AND TB04018_A.TB04018_TIPO = 'C'
		   AND TB04018_A.TB04018_COMPENSADO = 'S') -
	  
	   (SELECT SUM(TB04018_C.TB04018_VALOR)
	      FROM dbo.TB04018 AS TB04018_C
	     WHERE TB04018_C.TB04018_CODCADBANCO = dbo.TB04009.TB04009_CODIGO
		   AND TB04018_C.TB04018_TIPO = 'D'
		   AND TB04018_C.TB04018_COMPENSADO = 'S') IS NULL THEN    	  
	  
	   (SELECT SUM(TB04018_C.TB04018_VALOR)
	      FROM dbo.TB04018 AS TB04018_C
	     WHERE TB04018_C.TB04018_CODCADBANCO = dbo.TB04009.TB04009_CODIGO

		   AND TB04018_C.TB04018_COMPENSADO = 'S') ELSE

	   (SELECT SUM(TB04018_A.TB04018_VALOR)
	      FROM dbo.TB04018 AS TB04018_A
	     WHERE TB04018_A.TB04018_CODCADBANCO = dbo.TB04009.TB04009_CODIGO
		   AND TB04018_A.TB04018_TIPO = 'C'
		   AND TB04018_A.TB04018_COMPENSADO = 'S') -
	  
	   (SELECT SUM(TB04018_C.TB04018_VALOR)
	      FROM dbo.TB04018 AS TB04018_C
	     WHERE TB04018_C.TB04018_CODCADBANCO = dbo.TB04009.TB04009_CODIGO
		   AND TB04018_C.TB04018_TIPO = 'D'
		   AND TB04018_C.TB04018_COMPENSADO = 'S') END 

	  
AS Inicial,
	 
	 CASE WHEN TB04009_ANALISECAIXA = 'N' THEN 'Sim' ELSE 'NÃ£o' END ShowAccount

FROM TB04009
LEFT JOIN TB04008 ON TB04008_CODIGO = TB04009_BANCO
LEFT JOIN TB01007 ON TB01007_CODIGO = TB04009_CODEMP
                        
WHERE        (dbo.TB04009.TB04009_SITUACAO = 'A')
  --AND TB04009_ANALISECAIXA = 'N'

UNION

SELECT TB03001_CADEMP AS Codemp,
	   TB01007_NOME Empresa,
	   'Caixa' Banco,
	   'Caixa ' + TB01007_NOME CodConta,
	   'Caixa ' + TB01007_NOME Conta,
	   TB03001_VLRCAIXA Inicial,
	   'Sim' ShowAccount
FROM TB03001
LEFT JOIN TB01007 ON TB01007_CODIGO = TB03001_CADEMP                     
WHERE CAST(TB03001_DATA as date) = (SELECT CAST(MAX(TB03001_DATA) as date) FROM TB03001)


GO

