USE [DATACLASSIC]
GO

/****** Object:  View [dbo].[BM_CONTRLEITURA3]    Script Date: 26/02/2024 09:46:40 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE VIEW [dbo].[BM_CONTRLEITURA3] AS

SELECT TB02111_CODIGO Contrato,
	   TB02111_CODEMP Emp,
	   TB01007_NOME Empresa,
	   TB02111_CODCLI Codcli,

	   TB01008_NOME	Cliente,
	   TB02111_CODIGO + ' - ' + TB01008_NOME ClienteContrato,
	   TB02111_DIALEITURA Leitura,
	   TB01010_NOME Equipamento,
	   TB01010_GRUPO Grupo,
	   TB02112_PRODUTO CodProd,
	   TB02112_NUMSERIE Serie,
	   TB02112_PAT Pat,
	   TB02176_NOME Site,
	   TB02177_NOME Departamento,
	   TB00009_NOME Modulo,
	   TB02112_DATA Inst,
	   TB02112_DTINATIVO Desinst,
	   dbo.CALENDARIOMES.mes MesFechamento,

	  (SELECT TOP 1 ULTLEITURA.TB02117_MEDANTERIOR
	     FROM TB02117 AS ULTLEITURA
		WHERE ULTLEITURA.TB02117_NUMSERIE = dbo.TB02112.TB02112_NUMSERIE
		  AND ULTLEITURA.TB02117_CODIGO = dbo.TB02112.TB02112_CODIGO
		  AND ULTLEITURA.TB02117_PRODUTO = dbo.TB02112.TB02112_PRODUTO
		  AND SUBSTRING(CONVERT(VARCHAR(10), ULTLEITURA.TB02117_DATA, 103), 4, 7) <> dbo.CALENDARIOMES.mes
		ORDER BY ULTLEITURA.TB02117_DATA DESC) AnteriorPB,

	  (SELECT TOP 1 ULTLEITURA.TB02117_MEDANTERIORC
	     FROM TB02117 AS ULTLEITURA
		WHERE ULTLEITURA.TB02117_NUMSERIE = dbo.TB02112.TB02112_NUMSERIE
		  AND ULTLEITURA.TB02117_CODIGO = dbo.TB02112.TB02112_CODIGO
		  AND ULTLEITURA.TB02117_PRODUTO = dbo.TB02112.TB02112_PRODUTO
		  AND SUBSTRING(CONVERT(VARCHAR(10), ULTLEITURA.TB02117_DATA, 103), 4, 7) <> dbo.CALENDARIOMES.mes
		ORDER BY ULTLEITURA.TB02117_DATA DESC) AnteriorCor,

	  (SELECT TOP 1 ULTLEITURA.TB02117_MEDANTERIORGF
	     FROM TB02117 AS ULTLEITURA
		WHERE ULTLEITURA.TB02117_NUMSERIE = dbo.TB02112.TB02112_NUMSERIE
		  AND ULTLEITURA.TB02117_CODIGO = dbo.TB02112.TB02112_CODIGO
		  AND ULTLEITURA.TB02117_PRODUTO = dbo.TB02112.TB02112_PRODUTO
		  AND SUBSTRING(CONVERT(VARCHAR(10), ULTLEITURA.TB02117_DATA, 103), 4, 7) <> dbo.CALENDARIOMES.mes
		ORDER BY ULTLEITURA.TB02117_DATA DESC) AnteriorA3PB,

	  (SELECT TOP 1 ULTLEITURA.TB02117_MEDANTERIORGFC
	     FROM TB02117 AS ULTLEITURA
		WHERE ULTLEITURA.TB02117_NUMSERIE = dbo.TB02112.TB02112_NUMSERIE
		  AND ULTLEITURA.TB02117_CODIGO = dbo.TB02112.TB02112_CODIGO
		  AND ULTLEITURA.TB02117_PRODUTO = dbo.TB02112.TB02112_PRODUTO
		  AND SUBSTRING(CONVERT(VARCHAR(10), ULTLEITURA.TB02117_DATA, 103), 4, 7) <> dbo.CALENDARIOMES.mes
		ORDER BY ULTLEITURA.TB02117_DATA DESC) AnteriorA3Cor,

	  (SELECT TOP 1 ULTLEITURA.TB02117_MEDANTERIORDG
	     FROM TB02117 AS ULTLEITURA
		WHERE ULTLEITURA.TB02117_NUMSERIE = dbo.TB02112.TB02112_NUMSERIE
		  AND ULTLEITURA.TB02117_CODIGO = dbo.TB02112.TB02112_CODIGO
		  AND ULTLEITURA.TB02117_PRODUTO = dbo.TB02112.TB02112_PRODUTO
		  AND SUBSTRING(CONVERT(VARCHAR(10), ULTLEITURA.TB02117_DATA, 103), 4, 7) <> dbo.CALENDARIOMES.mes
		ORDER BY ULTLEITURA.TB02117_DATA DESC) AnteriorDig,

	   CASE WHEN (TB02117_TOTPB + TB02117_TOTCOLOR + TB02117_TOTGF + TB02117_TOTGFC + TB02117_TOTDG) >= 0 THEN 'Sim' ELSE 'Não' END Possui,
	   CASE WHEN (TB02117_TOTPB + TB02117_TOTCOLOR + TB02117_TOTGF + TB02117_TOTGFC + TB02117_TOTDG) >= 0 THEN 1 ELSE 0 END PossuiInt,
	   	
		isnull(TB02117_MEDANTERIOR, 0) AnteriorPB_C,
		isnull(TB02117_MEDATUAL, 0) AtualPB,
		isnull(TB02117_TOTPB, 0) ProdPB,

		isnull(TB02117_MEDANTERIORC, 0) AnteriorCor_C,
		isnull(TB02117_MEDATUALC, 0) AtualCor,		
		isnull(TB02117_TOTCOLOR, 0) ProdCor,

		isnull(TB02117_MEDANTERIORDG, 0) AnteriorDG_C,
		isnull(TB02117_MEDATUALDG, 0) AtualDG,		
		isnull(TB02117_TOTDG, 0) ProdDG,
		
		isnull(TB02117_TOTGF, 0) ProdA3PB,
		
		isnull(TB02117_TOTGFC, 0) ProdA3Cor,

		isnull(TB02127_VLRCONTR, 0) ValorFixo,
		isnull(TB02127_VLREXCEDPB + TB02127_VLREXCEDGF, 0) ValorExcPB,
		isnull(TB02127_VLREXCEDCOR + TB02127_VLREXCEDGFC, 0) ValorExcCor,
		isnull(TB02127_VLRTIRADASPB + TB02127_VLRTIRADASGF, 0) ValorTiradaPB,
		isnull(TB02127_VLRTIRADASCOR + TB02127_VLRTIRADASGFC, 0) ValorTiradaCor,

		TB02127_VLRTOTAL ValorTotal,
		TB02126_VLRDESC ValorDesconto,
		TB02126_VLRRETENCOES ValorRet,
		TB02126_VLRTOTAL ValorTotal2126,
		TB02126_RECIBO Recibo,
		TB02126_CODVENDA Pedido,

		CASE WHEN TB02126_MES IS NULL THEN 0 ELSE 1 END Fechamento,

	   CASE WHEN TB02112_DATA <= BM_PERIODO$.Fim THEN 1 ELSE 0 END InstaladaPeriodo,
	   CASE WHEN TB02112_DTINATIVO BETWEEN BM_PERIODO$.Inicio + 1 AND BM_PERIODO$.Fim - 1 THEN 1 ELSE 0 END DesinstalaPeriodo,
	   CASE WHEN TB02112_DTINATIVO < BM_PERIODO$.Inicio THEN 1 ELSE 0 END DesinstaladaAntes,

	   CASE WHEN TB02112_LIBLEITURA = 'N' THEN 'Sim' ELSE 'Não' END NecessarioLeitura,
	   CAST(TB02111_OPERADOR as varchar(100)) Responsavel,
	   TB01006_NOME Vendedor,

	   CAST(SUBSTRING(TB02127_MES, 4, 4) + '-' + SUBSTRING(TB02127_MES, 1, 2) + '-01 00:00:00' as datetime) MesDia, 
	   TB02111_VENCCONTR Vencimento,
	   TB02111_DTINICIO DataInicio, 
	   TB02111_DTREAJUSTE DataReajuste, 
	   TB02111_NOME Classif, 
	   
	   TB02112_END + ', ' + CAST(TB02112_NUM as varchar) Logradouro, 
	   TB02112_BAIRRO Bairro,
	   TB02112_CIDADE Cidade, 
	   TB02112_LOCAL Localizacao, 

	   TB02112_END + ', ' + CAST(TB02112_NUM as varchar) + ' - ' + TB02112_BAIRRO + ', ' + TB02112_CIDADE + ' - ' + TB02112_ESTADO + ', ' + SUBSTRING(TB02112_CEP, 1, 5) + '-' + SUBSTRING(TB02112_CEP, 6, 3) EndBing, 
	   
	   CASE WHEN TB02112_LIBLEITURA = 'S' THEN 'Sim' ELSE 'Não' END NecessidadeLeitura, 
	  (SELECT TOP 1 TB01089_NOME FROM TB02183 LEFT JOIN TB01089 ON TB01089_CODIGO = TB02183_STATUS WHERE TB02183_CONTRATO = TB02111.TB02111_CODIGO AND TB02183_STATUS IN ('0002', '0003', '0004', '0006')) StatusContrato, 
	  (SELECT TOP 1 TB01089_NOME FROM TB02183 LEFT JOIN TB01089 ON TB01089_CODIGO = TB02183_STATUS WHERE TB02183_CONTRATO = TB02111.TB02111_CODIGO AND TB02183_STATUS IN ('0008', '0009', '0010', '0011', '0012', '0013', '0014')) StatusLeitura, 
	  (SELECT TOP 1 TB01089_NOME FROM TB02183 LEFT JOIN TB01089 ON TB01089_CODIGO = TB02183_STATUS WHERE TB02183_CONTRATO = TB02111.TB02111_CODIGO AND TB02183_STATUS = '0016') StatusReajuste, 
	  (SELECT CAST(TB02183_OBS as varchar(100)) FROM TB02183 WHERE TB02183_CONTRATO = TB02111.TB02111_CODIGO AND TB02183_STATUS = '0018') StatusDataFat,

	  CAST(TB02111_OBS as varchar(max)) ObsContrato, 
	  TB01107_NOME GrupoEconomico,
	  TB04010_DTVENC VencimentoFinanceiro,
	  TB02126_DTCAD DataEmissao,
	  TB01019_NOME Nivel

	  --CASE WHEN TB02126_VLRTOTAL <> (SELECT TB02118_VLRNOTA FROM TB02118 WHERE TB02118_CODIGO = TB02126_RECIBO) THEN 'Sim' ELSE 'Não' END ValorAlterado

  FROM TB02112
LEFT JOIN TB02111 ON TB02111_CODIGO = TB02112_CODIGO
LEFT JOIN TB01008 ON TB01008_CODIGO = TB02111_CODCLI
LEFT JOIN TB01010 ON TB01010_CODIGO = TB02112_PRODUTO
CROSS JOIN CALENDARIOMES
LEFT JOIN TB02117 ON TB02117_CODIGO = TB02111_CODIGO
				 AND TB02117_PRODUTO = TB02112_PRODUTO
				 AND TB02117_NUMSERIE = TB02112_NUMSERIE
				 AND SUBSTRING(CONVERT(VARCHAR(10),TB02117_DATA, 103), 4, 7) = dbo.CALENDARIOMES.mes
LEFT JOIN BM_PERIODO$ ON BM_PERIODO$.Mes = dbo.CALENDARIOMES.mes
					 AND BM_PERIODO$.Dia = TB02111_DIALEITURA
LEFT JOIN TB02176 ON TB02176_CODIGO = TB02112_CODSITE
LEFT JOIN TB02177 ON TB02177_CODIGO = TB02112_CODDEPTO
LEFT JOIN TB00009 ON TB00009_CODIGO = TB02112_MODULO
LEFT JOIN TB02126 ON TB02126_CONTRATO = TB02111_CODIGO
				 AND TB02126_CODCLI = TB02111_CODCLI
				 AND TB02126_MES = dbo.CALENDARIOMES.mes
LEFT JOIN TB02127 ON TB02127_CONTRATO = TB02111_CODIGO
				 AND TB02127_NUMSERIE = TB02112_NUMSERIE
				 AND TB02127_PRODUTO = TB02112_PRODUTO
				 AND TB02127_MES = dbo.CALENDARIOMES.mes
LEFT JOIN TB01007 ON TB01007_CODIGO = TB02111_CODEMP
LEFT JOIN TB01006 ON TB01006_CODIGO = TB02111_VEND
LEFT JOIN TB01107 ON TB01107_CODIGO = TB01008_GRUPO
LEFT JOIN TB04010 ON TB04010_CODIGO2 = TB02126_CODVENDA AND TB04010_CODCLI = TB02111_CODCLI AND TB04010_CONTRATO = TB02111_CODIGO
LEFT JOIN TB01019 ON TB01019_CODIGO = TB01008_NIVEL

  
 WHERE TB02111_TIPOCONTR IN ('L', 'M')
 AND TB02112_DTINATIVO IS NULL


UNION

SELECT TB02111_CODIGO Contrato,
	   TB02111_CODEMP Emp,
	   TB01007_NOME Empresa,
	   TB02111_CODCLI Codcli,

	   TB01008_NOME	Cliente,
	   TB02111_CODIGO + ' - ' + TB01008_NOME ClienteContrato,
	   TB02111_DIALEITURA Leitura,
	   TB01010_NOME Equipamento,
	   TB01010_GRUPO Grupo,
	   TB02112_PRODUTO CodProd,
	   TB02112_NUMSERIE Serie,
	   TB02112_PAT Pat,
	   TB02176_NOME Site,
	   TB02177_NOME Departamento,
	   TB00009_NOME Modulo,
	   TB02112_DATA Inst,
	   TB02112_DTINATIVO Desinst,
	   dbo.CALENDARIOMES.mes MesFechamento,

	  (SELECT TOP 1 ULTLEITURA.TB02117_MEDANTERIOR
	     FROM TB02117 AS ULTLEITURA
		WHERE ULTLEITURA.TB02117_NUMSERIE = dbo.TB02112.TB02112_NUMSERIE
		  AND ULTLEITURA.TB02117_CODIGO = dbo.TB02112.TB02112_CODIGO
		  AND ULTLEITURA.TB02117_PRODUTO = dbo.TB02112.TB02112_PRODUTO
		  AND SUBSTRING(CONVERT(VARCHAR(10), ULTLEITURA.TB02117_DATA, 103), 4, 7) <> dbo.CALENDARIOMES.mes
		ORDER BY ULTLEITURA.TB02117_DATA DESC) AnteriorPB,

	  (SELECT TOP 1 ULTLEITURA.TB02117_MEDANTERIORC
	     FROM TB02117 AS ULTLEITURA
		WHERE ULTLEITURA.TB02117_NUMSERIE = dbo.TB02112.TB02112_NUMSERIE
		  AND ULTLEITURA.TB02117_CODIGO = dbo.TB02112.TB02112_CODIGO
		  AND ULTLEITURA.TB02117_PRODUTO = dbo.TB02112.TB02112_PRODUTO
		  AND SUBSTRING(CONVERT(VARCHAR(10), ULTLEITURA.TB02117_DATA, 103), 4, 7) <> dbo.CALENDARIOMES.mes
		ORDER BY ULTLEITURA.TB02117_DATA DESC) AnteriorCor,

	  (SELECT TOP 1 ULTLEITURA.TB02117_MEDANTERIORGF
	     FROM TB02117 AS ULTLEITURA
		WHERE ULTLEITURA.TB02117_NUMSERIE = dbo.TB02112.TB02112_NUMSERIE
		  AND ULTLEITURA.TB02117_CODIGO = dbo.TB02112.TB02112_CODIGO
		  AND ULTLEITURA.TB02117_PRODUTO = dbo.TB02112.TB02112_PRODUTO
		  AND SUBSTRING(CONVERT(VARCHAR(10), ULTLEITURA.TB02117_DATA, 103), 4, 7) <> dbo.CALENDARIOMES.mes
		ORDER BY ULTLEITURA.TB02117_DATA DESC) AnteriorA3PB,

	  (SELECT TOP 1 ULTLEITURA.TB02117_MEDANTERIORGFC
	     FROM TB02117 AS ULTLEITURA
		WHERE ULTLEITURA.TB02117_NUMSERIE = dbo.TB02112.TB02112_NUMSERIE
		  AND ULTLEITURA.TB02117_CODIGO = dbo.TB02112.TB02112_CODIGO
		  AND ULTLEITURA.TB02117_PRODUTO = dbo.TB02112.TB02112_PRODUTO
		  AND SUBSTRING(CONVERT(VARCHAR(10), ULTLEITURA.TB02117_DATA, 103), 4, 7) <> dbo.CALENDARIOMES.mes
		ORDER BY ULTLEITURA.TB02117_DATA DESC) AnteriorA3Cor,

	  (SELECT TOP 1 ULTLEITURA.TB02117_MEDANTERIORDG
	     FROM TB02117 AS ULTLEITURA
		WHERE ULTLEITURA.TB02117_NUMSERIE = dbo.TB02112.TB02112_NUMSERIE
		  AND ULTLEITURA.TB02117_CODIGO = dbo.TB02112.TB02112_CODIGO
		  AND ULTLEITURA.TB02117_PRODUTO = dbo.TB02112.TB02112_PRODUTO
		  AND SUBSTRING(CONVERT(VARCHAR(10), ULTLEITURA.TB02117_DATA, 103), 4, 7) <> dbo.CALENDARIOMES.mes
		ORDER BY ULTLEITURA.TB02117_DATA DESC) AnteriorDig,

	   CASE WHEN (TB02117_TOTPB + TB02117_TOTCOLOR + TB02117_TOTGF + TB02117_TOTGFC + TB02117_TOTDG) >= 0 THEN 'Sim' ELSE 'Não' END Possui,
	   CASE WHEN (TB02117_TOTPB + TB02117_TOTCOLOR + TB02117_TOTGF + TB02117_TOTGFC + TB02117_TOTDG) >= 0 THEN 1 ELSE 0 END PossuiInt,
	   	
		isnull(TB02117_MEDANTERIOR, 0) AnteriorPB_C,
		isnull(TB02117_MEDATUAL, 0) AtualPB,
		isnull(TB02117_TOTPB, 0) ProdPB,

		isnull(TB02117_MEDANTERIORC, 0) AnteriorCor_C,
		isnull(TB02117_MEDATUALC, 0) AtualCor,		
		isnull(TB02117_TOTCOLOR, 0) ProdCor,

		isnull(TB02117_MEDANTERIORDG, 0) AnteriorDG_C,
		isnull(TB02117_MEDATUALDG, 0) AtualDG,		
		isnull(TB02117_TOTDG, 0) ProdDG,
		
		isnull(TB02117_TOTGF, 0) ProdA3PB,
		
		isnull(TB02117_TOTGFC, 0) ProdA3Cor,

		isnull(TB02127_VLRCONTR, 0) ValorFixo,
		isnull(TB02127_VLREXCEDPB + TB02127_VLREXCEDGF, 0) ValorExcPB,
		isnull(TB02127_VLREXCEDCOR + TB02127_VLREXCEDGFC, 0) ValorExcCor,
		isnull(TB02127_VLRTIRADASPB + TB02127_VLRTIRADASGF, 0) ValorTiradaPB,
		isnull(TB02127_VLRTIRADASCOR + TB02127_VLRTIRADASGFC, 0) ValorTiradaCor,

		TB02127_VLRTOTAL ValorTotal,
		TB02126_VLRDESC ValorDesconto,
		TB02126_VLRRETENCOES ValorRet,
		TB02126_VLRTOTAL ValorTotal2126,
		TB02126_RECIBO Recibo,
		TB02126_CODVENDA Pedido,

		CASE WHEN TB02126_MES IS NULL THEN 0 ELSE 1 END Fechamento,

	   CASE WHEN TB02112_DATA <= BM_PERIODO$.Fim THEN 1 ELSE 0 END InstaladaPeriodo,
	   CASE WHEN TB02112_DTINATIVO BETWEEN BM_PERIODO$.Inicio + 1 AND BM_PERIODO$.Fim - 1 THEN 1 ELSE 0 END DesinstalaPeriodo,
	   CASE WHEN TB02112_DTINATIVO < BM_PERIODO$.Inicio THEN 1 ELSE 0 END DesinstaladaAntes,

	   CASE WHEN TB02112_LIBLEITURA = 'N' THEN 'Sim' ELSE 'Não' END NecessarioLeitura,
	   CAST(TB02111_OPERADOR as varchar(100)) Responsavel,
	   TB01006_NOME Vendedor,

	   CAST(SUBSTRING(TB02127_MES, 4, 4) + '-' + SUBSTRING(TB02127_MES, 1, 2) + '-01 00:00:00' as datetime) MesDia, 
	   TB02111_VENCCONTR Vencimento,
	   TB02111_DTINICIO DataInicio, 
	   TB02111_DTREAJUSTE DataReajuste, 
	   TB02111_NOME Classif, 
	   
	   TB02112_END + ', ' + CAST(TB02112_NUM as varchar) Logradouro, 
	   TB02112_BAIRRO Bairro,
	   TB02112_CIDADE Cidade, 
	   TB02112_LOCAL Localizacao, 

	   TB02112_END + ', ' + CAST(TB02112_NUM as varchar) + ' - ' + TB02112_BAIRRO + ', ' + TB02112_CIDADE + ' - ' + TB02112_ESTADO + ', ' + SUBSTRING(TB02112_CEP, 1, 5) + '-' + SUBSTRING(TB02112_CEP, 6, 3) EndBing, 
	   
	   CASE WHEN TB02112_LIBLEITURA = 'S' THEN 'Sim' ELSE 'Não' END NecessidadeLeitura, 
	  (SELECT TOP 1 TB01089_NOME FROM TB02183 LEFT JOIN TB01089 ON TB01089_CODIGO = TB02183_STATUS WHERE TB02183_CONTRATO = TB02111.TB02111_CODIGO AND TB02183_STATUS IN ('0002', '0003', '0004', '0006')) StatusContrato, 
	  (SELECT TOP 1 TB01089_NOME FROM TB02183 LEFT JOIN TB01089 ON TB01089_CODIGO = TB02183_STATUS WHERE TB02183_CONTRATO = TB02111.TB02111_CODIGO AND TB02183_STATUS IN ('0008', '0009', '0010', '0011', '0012', '0013', '0014')) StatusLeitura, 
	  (SELECT TOP 1 TB01089_NOME FROM TB02183 LEFT JOIN TB01089 ON TB01089_CODIGO = TB02183_STATUS WHERE TB02183_CONTRATO = TB02111.TB02111_CODIGO AND TB02183_STATUS = '0016') StatusReajuste, 
	  (SELECT CAST(TB02183_OBS as varchar(100)) FROM TB02183 WHERE TB02183_CONTRATO = TB02111.TB02111_CODIGO AND TB02183_STATUS = '0018') StatusDataFat,

	  CAST(TB02111_OBS as varchar(max)) ObsContrato, 
	  TB01107_NOME GrupoEconomico,
	  TB04010_DTVENC VencimentoFinanceiro,
	  TB02126_DTCAD DataEmissao,
	  TB01019_NOME Nivel

	  --CASE WHEN TB02126_VLRTOTAL <> (SELECT TB02118_VLRNOTA FROM TB02118 WHERE TB02118_CODIGO = TB02126_RECIBO) THEN 'Sim' ELSE 'Não' END ValorAlterado

  FROM TB02112
LEFT JOIN TB02111 ON TB02111_CODIGO = TB02112_CODIGO
LEFT JOIN TB01008 ON TB01008_CODIGO = TB02111_CODCLI
LEFT JOIN TB01010 ON TB01010_CODIGO = TB02112_PRODUTO
CROSS JOIN CALENDARIOMES
LEFT JOIN TB02117 ON TB02117_CODIGO = TB02111_CODIGO
				 AND TB02117_PRODUTO = TB02112_PRODUTO
				 AND TB02117_NUMSERIE = TB02112_NUMSERIE
				 AND SUBSTRING(CONVERT(VARCHAR(10),TB02117_DATA, 103), 4, 7) = dbo.CALENDARIOMES.mes
LEFT JOIN BM_PERIODO$ ON BM_PERIODO$.Mes = dbo.CALENDARIOMES.mes
					 AND BM_PERIODO$.Dia = TB02111_DIALEITURA
LEFT JOIN TB02176 ON TB02176_CODIGO = TB02112_CODSITE
LEFT JOIN TB02177 ON TB02177_CODIGO = TB02112_CODDEPTO
LEFT JOIN TB00009 ON TB00009_CODIGO = TB02112_MODULO
LEFT JOIN TB02126 ON TB02126_CONTRATO = TB02111_CODIGO
				 AND TB02126_CODCLI = TB02111_CODCLI
				 AND TB02126_MES = dbo.CALENDARIOMES.mes
LEFT JOIN TB02127 ON TB02127_CONTRATO = TB02111_CODIGO
				 AND TB02127_NUMSERIE = TB02112_NUMSERIE
				 AND TB02127_PRODUTO = TB02112_PRODUTO
				 AND TB02127_MES = dbo.CALENDARIOMES.mes
LEFT JOIN TB01007 ON TB01007_CODIGO = TB02111_CODEMP
LEFT JOIN TB01006 ON TB01006_CODIGO = TB02111_VEND
LEFT JOIN TB01107 ON TB01107_CODIGO = TB01008_GRUPO
LEFT JOIN TB04010 ON TB04010_CODIGO2 = TB02126_CODVENDA AND TB04010_CODCLI = TB02111_CODCLI AND TB04010_CONTRATO = TB02111_CODIGO
LEFT JOIN TB01019 ON TB01019_CODIGO = TB01008_NIVEL
  
 WHERE TB02111_TIPOCONTR IN ('L', 'M')
 AND TB02112_DTINATIVO >= DATEADD(MONTH, -2, GETDATE())  

GO

