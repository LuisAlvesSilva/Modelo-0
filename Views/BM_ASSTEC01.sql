USE [DATACLASSIC]
GO

/****** Object:  View [dbo].[BM_ASSTEC01]    Script Date: 05/03/2024 08:30:47 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE VIEW [dbo].[BM_ASSTEC01] AS

SELECT DISTINCT TB02115_CODIGO AS OS, 
	   CASE WHEN TB02115_PREVENTIVA = 'I' THEN 'Instalação' WHEN TB02115_PREVENTIVA = 'N' THEN 'Normal' WHEN TB02115_PREVENTIVA = 'D' THEN 'Desinstalação' WHEN TB02115_PREVENTIVA = 'P' THEN 'Preventiva' WHEN TB02115_PREVENTIVA = 'R' THEN 'Recarga' ELSE 'Recarga' END AS 'Tipo',
	   CASE VW02095.TB02111_TIPOCONTR WHEN 'A' THEN 'Avulso' WHEN 'G' THEN 'Garantia' WHEN 'M' THEN 'Manutenção' WHEN 'L' THEN 'Locação' END TipoContrato,
	   VW02095.TB02115_CODEMP AS Empresa,
	   VW02095.TB01007_NOME NomeEmpresa,
	   TB02115_DATA AS Data,
	   TB02115_DATA DataR,
	   TB02115_CODCLI CodCli,
	   TB01008_NOME Cliente,
	   TB02115_CONTRATO Contrato,
	   TB01008_NOME Classificação,
	   TB02115_NUMSERIE Serie,
	   TB02112_PAT Patromônio,
	   VW02095.TB01010_NOME AS Equipamento,
	   TB02112_CIDADE AS Cidade,
	   ISNULL(TECFECH.TB01024_NOME, TECNICO_PREST) Técnico,
       CALC_PREVISAO AS SLA,
	   CALC_RESTANTE 'Previsão',
	   CASE WHEN CALC_PREVISAO < CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime) THEN 'Sim' ELSE 'Não' END 'SLA Excedido',
       CASE WHEN CALC_PREVISAO < CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime) THEN 'Sim' ELSE 'Não' END 'SLA Excedido Num',
	   CASE WHEN CALC_PREVISAO < CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime) THEN 1 ELSE 0 END 'SLA Excedido Num2',
	   (CASE WHEN TB02115_DTFECHA IS NULL THEN 'Aberta' ELSE 'Fechada' END) Situação,
       TB01073_NOME AS Status,
	   CASE WHEN TB02115_OPCAD = 'DATASERVICE' THEN 'Web' ELSE 'Interna' END StatusIni,
	  
	  CASE WHEN
	  (SELECT TOP 1 TB02130_STATUS
	     FROM TB02130
		WHERE TB02130_CODIGO = VW02095.TB02115_CODIGO
		  AND TB02130_TIPO = 'O'
		  AND TB02130_CODCAD = VW02095.TB02115_CODCLI
		  AND TB02130_STATUS = 'O8') IS NULL THEN 'N1' ELSE 'Externo'END EnTecnicoHist,

	   dbo.TB02122.TB02122_DATAINI DataIni,
	   dbo.TB02122.TB02122_HORAINI HoraIni,
	   CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAINI + ':00' as datetime) DataHoraIniTIME,
	   
	   dbo.TB02122.TB02122_DATAFIM DataFim,
	   dbo.TB02122.TB02122_HORAFIM HoraFim,
	   CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime) DataHoraFimTIME,

	   CONVERT( VARCHAR(20), DATEDIFF(MI, 
										 CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAINI + ':00' as datetime),
										 CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime)
									  ) / 60) + ':' + RIGHT(REPLICATE('0', 2) + CONVERT(VARCHAR(10), DATEDIFF(MI,
																												 CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAINI + ':00' as datetime),
																												 CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime)
																											  ) % 60), 2) AS TesteProduzido,

	   NULL 'Tempo de Resposta Técnica',
	   TB02112_HORAS AS SLA_CONTRATO,
	   TB02115_DTFECHA 'Data Conclusão',
	   TB02115_DTFECHA 'Data ConclusãoR',
	   (CASE WHEN (SELECT SUM(TB02125_TOTVALOR) FROM TB02125 WHERE TB02125_CODIGO = (SELECT TB02122_CODIGO FROM TB02122 WHERE TB02122_NUMOS = TB02115_CODIGO) AND TB02125_CODSERV = '0000') IS NULL THEN 0 ELSE (SELECT SUM(TB02125_TOTVALOR) FROM TB02125 WHERE TB02125_CODIGO = (SELECT TB02122_CODIGO FROM TB02122 WHERE TB02122_NUMOS = TB02115_CODIGO) AND TB02125_CODSERV = '0000') END) 'Custo técnico',
	   (CASE WHEN (SELECT SUM(TB02125_TOTVALOR) FROM TB02125 WHERE TB02125_CODIGO = (SELECT TB02122_CODIGO FROM TB02122 WHERE TB02122_NUMOS = TB02115_CODIGO) AND TB02125_CODSERV = '0001') IS NULL THEN 0 ELSE (SELECT SUM(TB02125_TOTVALOR) FROM TB02125 WHERE TB02125_CODIGO = (SELECT TB02122_CODIGO FROM TB02122 WHERE TB02122_NUMOS = TB02115_CODIGO) AND TB02125_CODSERV = '0001') END) AS 'Custo Deslocamento',
	   (CASE WHEN (SELECT SUM(TB02124_CUSTO * TB02124_QTPROD) FROM TB02124 WHERE TB02124_CODIGO = (SELECT TB02122_CODIGO FROM TB02122 WHERE TB02122_NUMOS = TB02115_CODIGO)) IS NULL THEN 0 ELSE (SELECT SUM(TB02124_CUSTO * TB02124_QTPROD) FROM TB02124 WHERE TB02124_CODIGO = (SELECT TB02122_CODIGO FROM TB02122 WHERE TB02122_NUMOS = TB02115_CODIGO)) END) AS 'Custo peças',
	   TB01055_NOME AS 'Condição de Intervenção',
	   CASE WHEN CALC_RESTANTE <= 0 THEN 'https://image.ibb.co/h4B1FT/flag.png' WHEN CALC_RESTANTE BETWEEN 1 AND 8 THEN 'https://image.ibb.co/fxFmFT/alarm.png' ELSE 'https://image.ibb.co/mje5aT/time_left.png' END SLAImg,
	   convert(VARCHAR(5), CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + CASE WHEN SUBSTRING(dbo.TB02122.TB02122_HRDESLOC, 4, 2) > 23 THEN '00:00' WHEN dbo.TB02122.TB02122_HRDESLOC = '' THEN '00:00' WHEN dbo.TB02122.TB02122_HRDESLOC IS NULL THEN '00:00' WHEN LEN(dbo.TB02122.TB02122_HRDESLOC) < 5 THEN '00:00' ELSE dbo.TB02122.TB02122_HRDESLOC END + ':00' as datetime), 108) Deslocamento,
	   --CASE WHEN DATEDIFF(D, (SELECT TOP 1 dbo.TB02115.TB02115_DATA FROM TB02115 WHERE dbo.TB02115.TB02115_NUMSERIE = VW02095.TB02115_NUMSERIE AND CAST(dbo.TB02115.TB02115_CODIGO as int) < CAST(VW02095.TB02115_CODIGO as int) ORDER BY dbo.TB02115.TB02115_DATA DESC), VW02095.TB02115_DATA) >= 5 THEN 0 ELSE 1 END Reincidência,
	   --ALTERAÇÂO NA REINICIDENCIA PARA 15 DIAS DA ULTIMA OS E DEFEITOS IGUAIS
		CASE 
			WHEN DATEDIFF(D, (SELECT TOP 1 dbo.TB02115.TB02115_DATA 
						  FROM TB02115 
						  WHERE dbo.TB02115.TB02115_NUMSERIE = VW02095.TB02115_NUMSERIE AND CAST(dbo.TB02115.TB02115_CODIGO as int) < CAST(VW02095.TB02115_CODIGO as int) 
						  ORDER BY dbo.TB02115.TB02115_DATA DESC), VW02095.TB02115_DATA) <= 15 AND
						  VW02095.TB02115_NOME = (SELECT TOP 1 dbo.TB02115.TB02115_NOME 
												  FROM TB02115 
												  WHERE dbo.TB02115.TB02115_NUMSERIE = VW02095.TB02115_NUMSERIE AND CAST(dbo.TB02115.TB02115_CODIGO as int) < CAST(VW02095.TB02115_CODIGO as int) 
												  ORDER BY dbo.TB02115.TB02115_DATA DESC) THEN 1				  
			ELSE 0 
		END Reincidência,
	   dbo.TB02122.TB02122_CODIGO CodFech,
	   VW02095.TB02176_NOME Site,
	   CAST('08:00:00' as time) HorárioDia,
	   dbo.TB02122.TB02122_KMINICIAL KMInicial,
	   dbo.TB02122.TB02122_KMFINAL KMFinal,
	   dbo.TB02122.TB02122_KMFINAL - dbo.TB02122.TB02122_KMINICIAL KMSaldo,
	   dbo.TB02122.TB02122_PLACA Placa,

	  (SELECT TOP 1 TB01048_NOME FROM TB01048 LEFT JOIN TB02116 ON TB02116_DEFEITO = TB01048_CODIGO WHERE TB02116_CODIGO = VW02095.TB02115_CODIGO) Defeito,
	  TB02122.TB02122_CONTADOR ContPB,
	  TB02122.TB02122_CONTADORC ContCor,
	  TB01055_NOME CondIntervencao,

	  DATEDIFF(SS, TB02115_DATA, CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAINI + ':00' as datetime)) RespostaSLA,
	  DATEDIFF(SS, TB02115_DATA, CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime)) RespostaTecSLA,
	  DATEDIFF(SS, TB02115_DATA, CALC_PREVISAO) RespostaSLAPRevisao,
	  DATEDIFF(SS, CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAINI, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAINI + ':00' as datetime), CAST( SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime)) TempoProduzidoNovo,
	  
	   CASE WHEN CALC_PREVISAO < CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime) THEN DATEDIFF(SS, CALC_PREVISAO, CAST(SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 7, 7) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 4, 2) + '-' + SUBSTRING(CONVERT(VARCHAR(10),dbo.TB02122.TB02122_DATAFIM, 103), 1, 2) + ' ' + dbo.TB02122.TB02122_HORAFIM + ':00' as datetime)) ELSE 0 END SLA_Estourado_Segundos

  FROM VW02095

LEFT JOIN TB02122 ON dbo.TB02122.TB02122_NUMOS = VW02095.TB02115_CODIGO
				 AND dbo.TB02122.TB02122_CODCLI = VW02095.TB02115_CODCLI
				 AND dbo.TB02122.TB02122_CONTRATO = VW02095.TB02115_CONTRATO
				 AND dbo.TB02122.TB02122_NUMSERIE = VW02095.TB02115_NUMSERIE
LEFT JOIN TB01024 AS TECFECH ON TECFECH.TB01024_CODIGO = dbo.TB02122.TB02122_CODTEC
 WHERE TB02115_situacao = 'A'
   AND YEAR(TB02115_DATA) > 2019
   AND YEAR(TB02122.TB02122_DATAINI) > 2019
   AND YEAR(TB02122.TB02122_DATAFIM) > 2019

GO

