USE [DATACLASSIC]
GO

/****** Object:  View [dbo].[BM_FATURAMENTOTOT]    Script Date: 26/02/2024 09:45:52 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE VIEW [dbo].[BM_FATURAMENTOTOT] AS

SELECT Pedido,
	   NULL Parcelas,
	   [Data],
	   Empresa,
	   Nota,
	   Cliente,
	   Servico Item,
	   Valor,
	   Comissao,
	   Vendedor,
	   GrupoEco,
	   Nivel,
	   'Faturamento de Serviços Diversos' Tipo,
	   NULL Serie
  FROM BM_FATURAMENTOS

UNION

SELECT Pedido,
	   NULL Parcelas,
	   [Data],
	   Empresa,
	   NotaFiscal Nota,
	   Cliente,
	   Produto Item,
	   ValorTotal,
	   Comissão Comissao,
	   Vendedor,
	   GrupoEconomico GrupoEco,
	   Nível Nivel,
	   'Faturamento de Vendas' Tipo,
	   NULL Serie
  FROM BM_FATURAMENTO
 WHERE CodOperacao NOT IN ('14', '15', '34', '35')
 AND CodCli NOT IN ('00000000', '00002151', '00000855')

UNION

SELECT TB02118_CODIGO Pedido,
	   NULL Parcelas,
	   TB02118_DATA [Data],
	   TB01007_NOME Empresa,
	   TB02118_CODIGO Nota,
	   TB01008_NOME Cliente,
	   'RECIBO DE LOCAÇÃO ' Item,
	   TB02118_VLRNOTA ValorTotal,
	   0 Comissao,
	   TB01006_NOME Vendedor,
	   TB01107_NOME GrupoEco,
	   TB01019_NOME Nivel,
	   'Faturamento Locação' Tipo,
	   NULL Serie
  FROM TB02118
LEFT JOIN TB01008 ON TB01008_CODIGO = TB02118_CODCLI
LEFT JOIN TB01007 ON TB01007_CODIGO = TB02118_CODEMP
LEFT JOIN TB01006 ON TB01006_CODIGO = TB02118_VEND
LEFT JOIN TB01107 ON TB01007_CODIGO = TB01008_GRUPO
LEFT JOIN TB01019 ON TB01019_CODIGO = TB01008_NIVEL

UNION

SELECT TB02021_CODIGO Pedido,
	   NULL Parcelas,
	   TB02021_DATA [Data],
	   TB01007_NOME Empresa,
	   TB02021_NTSERV Nota,
	   TB01008_NOME Cliente,
	   'NFS-E DE LOCAÇÃO ' Item,
	   TB02023_TOTVALOR ValorTotal,
	   0 Comissao,
	   TB01006_NOME Vendedor,
	   TB01107_NOME GrupoEco,
	   TB01019_NOME Nivel,
	   'Faturamento Locação' Tipo,
	   NULL Serie
  FROM TB02023
LEFT JOIN TB02021 ON TB02021_CODIGO = TB02023_CODIGO
LEFT JOIN TB01007 ON TB01007_CODIGO = TB02021_CODEMP
LEFT JOIN TB01008 ON TB01008_CODIGO = TB02021_CODCLI
LEFT JOIN TB01005 ON TB01005.TB01005_CODIGO = TB02023_CODSERV
LEFT JOIN TB01006 ON TB01006_CODIGO = TB02021_VEND
LEFT JOIN TB01107 ON TB01107_CODIGO = TB01008_GRUPO
LEFT JOIN TB01019 ON TB01019_CODIGO = TB01008_NIVEL
 WHERE TB02021_TIPODESC = '19'

UNION

SELECT TB02021_CODIGO Pedido,
	   NULL Parcelas,
	   TB02021_DATA [Data],
	   TB01007_NOME Empresa,
	   TB02021_NTSERV Nota,
	   TB01008_NOME Cliente,
	   'NFS-E DE LOCAÇÃO ' Item,
	   TB02023_TOTVALOR ValorTotal,
	   0 Comissao,
	   TB01006_NOME Vendedor,
	   TB01107_NOME GrupoEco,
	   TB01019_NOME Nivel,
	   'Faturamento HTF' Tipo,
	   NULL Serie
  FROM TB02023
LEFT JOIN TB02021 ON TB02021_CODIGO = TB02023_CODIGO
LEFT JOIN TB01007 ON TB01007_CODIGO = TB02021_CODEMP
LEFT JOIN TB01008 ON TB01008_CODIGO = TB02021_CODCLI
LEFT JOIN TB01005 ON TB01005.TB01005_CODIGO = TB02023_CODSERV
LEFT JOIN TB01006 ON TB01006_CODIGO = TB02021_VEND
LEFT JOIN TB01107 ON TB01107_CODIGO = TB01008_GRUPO
LEFT JOIN TB01019 ON TB01019_CODIGO = TB01008_NIVEL
 WHERE TB02021_TIPODESC = '29'

 UNION

SELECT ISNULL(Recibo, Pedido) Pedido,
	   NULL Parcelas,
	   CAST(SUBSTRING(MesFechamento, 4, 4) + '-' + SUBSTRING(MesFechamento, 1, 2) + '-01 00:00:00' as datetime) [Data],
	   Empresa,
	   ISNULL(Recibo, Pedido) Nota,
	   Cliente,
	   CAST(TB01049_OBS as varchar(100)) Item,
	   TB02128_VLRTOTAL ValorTotal,
	   0 Comissao,
	   Vendedor,
	   GrupoEconomico GrupoEco,
	   Nivel,
	   'Faturamento Locação Det' Tipo,
	   Serie
  FROM BM_CONTRLEITURA3
LEFT JOIN TB02128 ON TB02128_CONTRATO = Contrato AND TB02128_MES = MesFechamento AND TB02128_NUMSERIE = Serie AND TB02128_PRODUTO = CodProd
LEFT JOIN TB01049 ON TB01049_CODIGO = TB02128_COBERTURA
 WHERE TB02128_VLRTOTAL IS NOT NULL


UNION

SELECT TB02126_CODVENDA Pedido,
	   NULL Parcelas,
	   SUBSTRING(TB02126_MES, 4, 4) + '-' + SUBSTRING(TB02126_MES, 1, 2) + '-01 00:00:00' [Data],
	   TB01007_NOME Empresa,
	   TB02126_CODVENDA Nota,
	   TB01008_NOME Cliente,
	   'Desconto' Item,
	   SUM(TB02126_VLRDESC) - (SUM(TB02126_VLRDESC) * 2) ValorTotal,
	   0 Comissao,
	   TB01006_NOME Vendedor,
	   TB01107_NOME GrupoEco,
	   TB01019_NOME Nivel,
	   'Faturamento Locação Det' Tipo,
	   '' Serie
  FROM TB02126 
LEFT JOIN TB01008 ON TB01008_CODIGO = TB02126_CODCLI
LEFT JOIN TB02111 ON TB02111_CODIGO = TB02126_CONTRATO
LEFT JOIN TB01007 ON TB01007_CODIGO = TB02111_CODEMP
LEFT JOIN TB01006 ON TB01006_CODIGO = TB02111_VEND
LEFT JOIN TB01107 ON TB01107_CODIGO = TB01008_GRUPO
LEFT JOIN TB01019 ON TB01019_CODIGO = TB01008_NIVEL
 WHERE TB02126_VLRDESC <> 0
GROUP BY TB02126.TB02126_CODVENDA, TB02126.TB02126_DTCAD, TB01007.TB01007_NOME,
	     TB01008.TB01008_NOME, TB01006.TB01006_NOME, TB01107.TB01107_NOME, TB01019.TB01019_NOME, TB02126.TB02126_MES

UNION

SELECT TB04010_CODIGO2 Pedido,
		TB04010_CODIGO Parcelas,
	   TB04010_DATA [Data],
	   TB01007_NOME Empresa,
	   TB04010_CODIGO2 Nota,
	   TB01008_NOME Cliente,
	   'Baixa Financeiro ' Item,
	   TB04010_VLRPAGO ValorTotal,
	   0 Comissao,
	   TB01006_NOME Vendedor,
	   TB01107_NOME GrupoEco,
	   TB01019_NOME Nivel,
	   CASE 
		WHEN TB04010_CODSUB = '0161' THEN 'R Faturamento de Serviços Diversos'
		WHEN TB04010_CODSUB IN ('0128','0157','0159') THEN 'R Faturamento de Vendas'
		WHEN TB04010_CODSUB = '0162' THEN 'R Faturamento Locação'
		WHEN TB04010_CODSUB IN ('0163','0036','0003') THEN 'R Faturamento HTF'
	    END Tipo,
	   NULL Serie
  FROM TB04010
LEFT JOIN TB01008 ON TB01008_CODIGO = TB04010_CODCLI
LEFT JOIN TB01007 ON TB01007_CODIGO = TB04010_CODEMP
LEFT JOIN TB01006 ON TB01006_CODIGO = TB04010_VEND
LEFT JOIN TB01107 ON TB01007_CODIGO = TB01008_GRUPO
LEFT JOIN TB01019 ON TB01019_CODIGO = TB01008_NIVEL
LEFT JOIN TB04011 ON TB04011_CODIGO = TB04010_CODIGO AND TB04011_CODCLI = TB04010_CODCLI
WHERE TB04011_DTBAIXA IS NOT NULL


GO

